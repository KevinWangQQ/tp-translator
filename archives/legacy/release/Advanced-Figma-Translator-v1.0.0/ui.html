<!doctype html><html><head><meta charset="utf-8"><title>Advanced Translator</title><style>* { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      background: #f5f5f5;
      height: 100vh;
    }
    
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: #fff;
      border-bottom: 1px solid #e1e4e8;
      padding: 16px;
      flex-shrink: 0;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #0366d6;
    }
    
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .section {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #24292e;
    }
    
    .selection-info {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      display: block;
      font-size: 24px;
      font-weight: 600;
      color: #0366d6;
    }
    
    .stat-label {
      font-size: 12px;
      color: #586069;
    }
    
    .options-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .option-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .option-label {
      font-size: 12px;
      font-weight: 500;
      color: #24292e;
    }
    
    .select, .input {
      padding: 8px 12px;
      border: 1px solid #d1d5da;
      border-radius: 4px;
      font-size: 14px;
      background: #fff;
    }
    
    .select:focus, .input:focus {
      outline: none;
      border-color: #0366d6;
      box-shadow: 0 0 0 2px rgba(3,102,214,0.1);
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .btn-primary {
      background: #28a745;
      color: #fff;
    }
    
    .btn-primary:hover { background: #218838; }
    
    .btn-secondary {
      background: #6c757d;
      color: #fff;
    }
    
    .btn-secondary:hover { background: #5a6268; }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .progress-section {
      margin-top: 16px;
    }
    
    .progress-bar {
      height: 6px;
      background: #e1e4e8;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: #28a745;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-size: 12px;
      color: #586069;
      text-align: center;
    }
    
    .result-item {
      border: 1px solid #e1e4e8;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .result-item.success { border-color: #28a745; }
    .result-item.error { border-color: #dc3545; }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .result-index {
      font-weight: 600;
      color: #0366d6;
    }
    
    .result-status {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .result-status.success { background: #d4edda; color: #155724; }
    .result-status.error { background: #f8d7da; color: #721c24; }
    
    .text-content {
      background: #f6f8fa;
      padding: 8px;
      border-radius: 4px;
      margin-top: 4px;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .notification {
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
    }
    
    .notification.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .notification.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    .status-connected {
      color: #28a745;
    }
    
    .status-disconnected {
      color: #dc3545;
    }</style></head><body><div id="root"><div class="app"><header class="header"><div class="logo"><span>ğŸŒ</span> <span>Advanced Translator</span> <span id="connection-status" class="status-disconnected">(è¿æ¥ä¸­...)</span></div></header><div class="content"><div class="section"><h3 class="section-title"><span>ğŸ“‹</span> <span>é€‰æ‹©ä¿¡æ¯</span></h3><div class="selection-info"><div class="stat"><span class="stat-value" id="total-nodes">0</span> <span class="stat-label">æ€»èŠ‚ç‚¹</span></div><div class="stat"><span class="stat-value" id="text-nodes">0</span> <span class="stat-label">æ–‡æœ¬èŠ‚ç‚¹</span></div></div><button class="btn btn-secondary" onclick="refreshSelection()">ğŸ”„ åˆ·æ–°é€‰æ‹©</button></div><div class="section"><h3 class="section-title"><span>âš™ï¸</span> <span>ç¿»è¯‘é€‰é¡¹</span></h3><div class="options-grid"><div class="option-group"><label class="option-label">ç¿»è¯‘å¼•æ“</label> <select class="select" id="engine"><option value="openai">OpenAI GPT</option><option value="gemini">Google Gemini</option></select></div><div class="option-group"><label class="option-label">APIå¯†é’¥</label> <input type="password" class="input" id="api-key" placeholder="è¾“å…¥APIå¯†é’¥"></div><div class="option-group"><label class="option-label">æºè¯­è¨€</label> <select class="select" id="source-lang"><option value="auto">è‡ªåŠ¨æ£€æµ‹</option><option value="en">è‹±è¯­</option><option value="zh-CN">ä¸­æ–‡(ç®€ä½“)</option><option value="ja">æ—¥è¯­</option><option value="ko">éŸ©è¯­</option></select></div><div class="option-group"><label class="option-label">ç›®æ ‡è¯­è¨€</label> <select class="select" id="target-lang"><option value="zh-CN" selected="selected">ä¸­æ–‡(ç®€ä½“)</option><option value="en">è‹±è¯­</option><option value="ja">æ—¥è¯­</option><option value="ko">éŸ©è¯­</option></select></div></div><div class="option-group"><label class="option-label">è¾“å‡ºæ¨¡å¼</label> <select class="select" id="output-mode"><option value="replace">æ›¿æ¢åŸæ–‡</option><option value="beside">åŸæ–‡æ—è¾¹</option><option value="newFrame">æ–°å»ºæ¡†æ¶</option><option value="newPage">æ–°å»ºé¡µé¢</option></select></div></div><div class="section"><h3 class="section-title"><span>ğŸš€</span> <span>ç¿»è¯‘æ“ä½œ</span></h3><button class="btn btn-primary" id="start-btn" onclick="startTranslation()" disabled="disabled">å¼€å§‹ç¿»è¯‘</button> <button class="btn btn-secondary" onclick="testEngine()">æµ‹è¯•å¼•æ“</button><div class="progress-section" id="progress-section" style="display: none;"><div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div><div class="progress-text" id="progress-text">ç¿»è¯‘è¿›åº¦: 0%</div></div></div><div class="section" id="results-section" style="display: none;"><h3 class="section-title"><span>ğŸ“„</span> <span>ç¿»è¯‘ç»“æœ</span></h3><div id="results-container"></div></div></div></div></div><div class="notification" id="notification"></div><script>console.log('Advanced Translator UI loading...');
    
    // åº”ç”¨çŠ¶æ€
    let appState = {
      connected: false,
      isTranslating: false,
      selection: { totalNodes: 0, textNodes: 0, nodeIds: [] },
      results: []
    };
    
    // æ›´æ–°UIå…ƒç´ 
    function updateUI() {
      document.getElementById('total-nodes').textContent = appState.selection.totalNodes;
      document.getElementById('text-nodes').textContent = appState.selection.textNodes;
      
      const startBtn = document.getElementById('start-btn');
      const hasSelection = appState.selection.textNodes > 0;
      const hasApiKey = document.getElementById('api-key').value.trim() !== '';
      
      startBtn.disabled = !hasSelection || !hasApiKey || appState.isTranslating;
      startBtn.textContent = appState.isTranslating ? 'ğŸ”„ ç¿»è¯‘ä¸­...' : 'ğŸš€ å¼€å§‹ç¿»è¯‘';
      
      // è¿æ¥çŠ¶æ€
      const statusEl = document.getElementById('connection-status');
      if (appState.connected) {
        statusEl.textContent = '(å·²è¿æ¥)';
        statusEl.className = 'status-connected';
      } else {
        statusEl.textContent = '(æœªè¿æ¥)';
        statusEl.className = 'status-disconnected';
      }
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification ' + type;
      notification.style.display = 'block';
      
      setTimeout(function() {
        notification.style.display = 'none';
      }, 3000);
    }
    
    // å‘é€æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹
    function postMessage(type, payload) {
      const message = { type: type, payload: payload || {} };
      console.log('å‘é€æ¶ˆæ¯:', message);
      parent.postMessage({ pluginMessage: message }, '*');
    }
    
    // åˆ·æ–°é€‰æ‹©
    function refreshSelection() {
      console.log('åˆ·æ–°é€‰æ‹©ä¿¡æ¯');
      postMessage('get-selection');
    }
    
    // æµ‹è¯•å¼•æ“
    function testEngine() {
      const engine = document.getElementById('engine').value;
      const apiKey = document.getElementById('api-key').value.trim();
      
      if (!apiKey) {
        showNotification('è¯·è¾“å…¥APIå¯†é’¥', 'error');
        return;
      }
      
      console.log('æµ‹è¯•å¼•æ“:', engine);
      postMessage('test-engine', {
        engine: engine,
        config: { apiKey: apiKey }
      });
    }
    
    // å¼€å§‹ç¿»è¯‘
    function startTranslation() {
      const engine = document.getElementById('engine').value;
      const apiKey = document.getElementById('api-key').value.trim();
      const sourceLang = document.getElementById('source-lang').value;
      const targetLang = document.getElementById('target-lang').value;
      const mode = document.getElementById('output-mode').value;
      
      if (!apiKey) {
        showNotification('è¯·è¾“å…¥APIå¯†é’¥', 'error');
        return;
      }
      
      if (appState.selection.textNodes === 0) {
        showNotification('è¯·å…ˆé€‰æ‹©åŒ…å«æ–‡æœ¬çš„èŠ‚ç‚¹', 'error');
        return;
      }
      
      console.log('å¼€å§‹ç¿»è¯‘:', { engine, sourceLang, targetLang, mode });
      
      appState.isTranslating = true;
      appState.results = [];
      updateUI();
      
      document.getElementById('progress-section').style.display = 'block';
      document.getElementById('results-section').style.display = 'block';
      document.getElementById('results-container').innerHTML = '';
      
      postMessage('start-translation', {
        engine: engine,
        sourceLang: sourceLang,
        targetLang: targetLang,
        mode: mode,
        nodeIds: appState.selection.nodeIds,
        config: { apiKey: apiKey }
      });
    }
    
    // æ›´æ–°è¿›åº¦
    function updateProgress(progress) {
      document.getElementById('progress-fill').style.width = progress + '%';
      document.getElementById('progress-text').textContent = 'ç¿»è¯‘è¿›åº¦: ' + Math.round(progress) + '%';
    }
    
    // æ·»åŠ ç¿»è¯‘ç»“æœ
    function addResult(result) {
      appState.results.push(result);
      
      const container = document.getElementById('results-container');
      const resultEl = document.createElement('div');
      resultEl.className = 'result-item ' + result.status;
      
      resultEl.innerHTML = `
        <div class="result-header">
          <span class="result-index">${appState.results.length}</span>
          <span class="result-status ${result.status}">
            ${result.status === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}
          </span>
        </div>
        <div>
          <label>åŸæ–‡:</label>
          <div class="text-content">${escapeHtml(result.originalText)}</div>
        </div>
        ${result.translatedText ? `
          <div>
            <label>è¯‘æ–‡:</label>
            <div class="text-content">${escapeHtml(result.translatedText)}</div>
          </div>
        ` : ''}
        ${result.error ? `
          <div>
            <label>é”™è¯¯:</label>
            <div class="text-content" style="background: #f8d7da;">${escapeHtml(result.error)}</div>
          </div>
        ` : ''}
      `;
      
      container.appendChild(resultEl);
      resultEl.scrollIntoView({ behavior: 'smooth' });
    }
    
    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // å¤„ç†æ¥è‡ªä¸»çº¿ç¨‹çš„æ¶ˆæ¯
    function handleMessage(message) {
      console.log('æ”¶åˆ°æ¶ˆæ¯:', message.type, message);
      
      switch (message.type) {
        case 'plugin-ready':
          appState.connected = true;
          updateUI();
          showNotification('æ’ä»¶å·²è¿æ¥', 'success');
          // è‡ªåŠ¨è·å–é€‰æ‹©ä¿¡æ¯
          setTimeout(refreshSelection, 100);
          break;
          
        case 'selection-info':
          appState.selection = {
            totalNodes: message.payload.totalNodes || 0,
            textNodes: message.payload.textNodes || 0,
            nodeIds: message.payload.nodeIds || []
          };
          updateUI();
          break;
          
        case 'translation-progress':
          updateProgress(message.payload.progress);
          break;
          
        case 'translation-result':
          addResult(message.payload);
          break;
          
        case 'translation-complete':
          appState.isTranslating = false;
          updateUI();
          updateProgress(100);
          showNotification(
            `ç¿»è¯‘å®Œæˆï¼æˆåŠŸ ${message.payload.successCount} ä¸ªï¼Œå¤±è´¥ ${message.payload.failureCount} ä¸ª`, 
            'success'
          );
          break;
          
        case 'engine-test-result':
          if (message.payload.success) {
            showNotification(message.payload.engine + ' è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
          } else {
            showNotification(message.payload.engine + ' è¿æ¥æµ‹è¯•å¤±è´¥: ' + message.payload.error, 'error');
          }
          break;
          
        case 'error':
          showNotification(message.payload.error, 'error');
          if (appState.isTranslating) {
            appState.isTranslating = false;
            updateUI();
          }
          break;
          
        default:
          console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
      }
    }
    
    // ç›‘å¬æ¥è‡ªä¸»çº¿ç¨‹çš„æ¶ˆæ¯
    window.addEventListener('message', function(event) {
      if (event.data.pluginMessage) {
        handleMessage(event.data.pluginMessage);
      }
    });
    
    // APIå¯†é’¥è¾“å…¥ç›‘å¬
    document.getElementById('api-key').addEventListener('input', updateUI);
    
    // åˆå§‹åŒ–
    updateUI();
    
    // å°è¯•è¿æ¥åˆ°æ’ä»¶
    setTimeout(function() {
      console.log('å°è¯•è¿æ¥åˆ°æ’ä»¶...');
      postMessage('get-selection');
    }, 500);
    
    console.log('Advanced Translator UI initialized');</script></body></html>