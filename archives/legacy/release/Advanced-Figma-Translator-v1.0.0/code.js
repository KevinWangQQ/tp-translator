(()=>{function t(){}function e(){}function n(){this.isTranslating=!1,this.translationEngine=new t,this.figmaService=new e}function a(){this.messageHandler=new n,this.figmaService=new e}function o(t,e){console.error("Error in "+e+":",t),figma.ui&&figma.ui.postMessage({type:"error",payload:{error:t.message,context:e}})}console.log("Production Plugin loading..."),t.prototype.translateText=async function(t,e,n,a,o){console.log("Translating with "+a+":",{text:t,sourceLang:e,targetLang:n});try{if("openai"===a)return await this.translateWithOpenAI(t,e,n,o);if("gemini"===a)return await this.translateWithGemini(t,e,n,o);throw new Error("Unsupported engine: "+a)}catch(t){throw console.error("Translation error:",t),t}},t.prototype.translateWithOpenAI=async function(t,e,n,a){const o=this.buildTranslationPrompt(t,e,n),s=await fetch("https://api.openai.com/v1/completions",{method:"POST",headers:{Authorization:"Bearer "+a.apiKey,"Content-Type":"application/json"},body:JSON.stringify({model:a.model||"gpt-3.5-turbo-instruct",prompt:o,max_tokens:1e3,temperature:.3,stop:["\\n\\n"]})});if(!s.ok){const t=await s.json(),e=t.error&&t.error.message||s.statusText;throw new Error("OpenAI API error: "+e)}const r=await s.json(),i=r.choices&&r.choices[0]&&r.choices[0].text&&r.choices[0].text.trim();if(!i)throw new Error("No translation returned from OpenAI");return i},t.prototype.translateWithGemini=async function(t,e,n,a){const o=this.buildTranslationPrompt(t,e,n),s=await fetch("https://generativelanguage.googleapis.com/v1beta/models/"+a.model+":generateContent?key="+a.apiKey,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:o}]}],generationConfig:{temperature:.3,maxOutputTokens:1e3}})});if(!s.ok){const t=await s.json(),e=t.error&&t.error.message||s.statusText;throw new Error("Gemini API error: "+e)}const r=await s.json(),i=r.candidates&&r.candidates[0]&&r.candidates[0].content&&r.candidates[0].content.parts&&r.candidates[0].content.parts[0]&&r.candidates[0].content.parts[0].text&&r.candidates[0].content.parts[0].text.trim();if(!i)throw new Error("No translation returned from Gemini");return i},t.prototype.buildTranslationPrompt=function(t,e,n){const a={auto:"自动检测",en:"English","zh-CN":"Simplified Chinese","zh-TW":"Traditional Chinese",ja:"Japanese",ko:"Korean",fr:"French",de:"German",es:"Spanish"},o=a[n]||n;return"auto"===e?"Translate the following text to "+o+". Only return the translated text, no explanations:\n\n"+t:"Translate the following "+(a[e]||e)+" text to "+o+". Only return the translated text, no explanations:\n\n"+t},t.prototype.testConnection=async function(t,e){try{return await this.translateText("Hello","en","zh-CN",t,e),!0}catch(t){return console.error("Connection test failed:",t),!1}},e.prototype.getSelectedTextNodes=function(){const t=figma.currentPage.selection,e=[];for(let n=0;n<t.length;n++)"TEXT"===t[n].type&&e.push(t[n]);return e},e.prototype.getSelectionInfo=function(){const t=figma.currentPage.selection,e=this.getSelectedTextNodes(),n=[],a=[];for(let t=0;t<e.length;t++)n.push(e[t].id),a.push(e[t].characters||"");return{totalNodes:t.length,textNodes:e.length,nodeIds:n,textContents:a}},e.prototype.applyTranslation=async function(t,e,n){const a=figma.getNodeById(t);if(!a||"TEXT"!==a.type)throw new Error("Node not found or not a text node");switch(await figma.loadFontAsync(a.fontName),n){case"replace":a.characters=e;break;case"beside":await this.createBesideText(a,e);break;case"newFrame":await this.createFrameWithTranslation(a,e);break;case"newPage":await this.createPageWithTranslation(a,e);break;default:throw new Error("Unsupported mode: "+n)}},e.prototype.createBesideText=async function(t,e){const n=t.clone();n.characters=e,n.x=t.x+t.width+20;const a=t.fills.slice();a.length>0&&"SOLID"===a[0].type&&(a[0]=Object.assign({},a[0],{color:{r:0,g:.5,b:0}}),n.fills=a)},e.prototype.createFrameWithTranslation=async function(t,e){const n=figma.createFrame();n.name="Translation Frame",n.x=t.x+t.width+50,n.y=t.y;const a=t.clone();a.x=0,a.y=0,n.appendChild(a);const o=t.clone();o.characters=e,o.x=0,o.y=a.height+10,n.appendChild(o),n.resize(Math.max(a.width,o.width)+20,a.height+o.height+30),n.backgrounds=[{type:"SOLID",color:{r:.95,g:.95,b:.95}}]},e.prototype.createPageWithTranslation=async function(t,e){const n=figma.createPage();n.name="Translation - "+(new Date).toLocaleString();const a=t.clone();a.x=100,a.y=100,n.appendChild(a);const o=t.clone();o.characters=e,o.x=100,o.y=a.y+a.height+50,n.appendChild(o)},n.prototype.handleMessage=async function(t){console.log("Handling message:",t.type);try{switch(t.type){case"get-selection":return{type:"selection-info",payload:this.figmaService.getSelectionInfo()};case"start-translation":return await this.handleStartTranslation(t.payload);case"cancel-translation":return this.isTranslating=!1,{type:"translation-cancelled"};case"apply-translation":return await this.handleApplyTranslation(t.payload);case"test-engine":return await this.handleTestEngine(t.payload);default:return console.log("Unknown message type:",t.type),null}}catch(t){return console.error("Message handling error:",t),{type:"error",payload:{error:t.message}}}},n.prototype.handleStartTranslation=async function(t){if(this.isTranslating)throw new Error("Translation already in progress");this.isTranslating=!0;const e=t.engine,n=t.sourceLang,a=t.targetLang,o=(t.mode,t.nodeIds),s=[];let r=0,i=0;try{const t=this.getEngineConfig(e);for(let c=0;c<o.length&&this.isTranslating;c++){const l=o[c],p=figma.getNodeById(l);if(!p||"TEXT"!==p.type){const t={nodeId:l,originalText:"",translatedText:"",status:"error",error:"Node not found or not a text node"};s.push(t),i++,this.postMessage({type:"translation-result",payload:t});continue}const g=p.characters||"";try{this.postMessage({type:"translation-progress",payload:{progress:c/o.length*100}});const i={nodeId:l,originalText:g,translatedText:await this.translationEngine.translateText(g,n,a,e,t),status:"success"};s.push(i),r++,this.postMessage({type:"translation-result",payload:i})}catch(t){const e={nodeId:l,originalText:g,translatedText:"",status:"error",error:t.message};s.push(e),i++,this.postMessage({type:"translation-result",payload:e})}await new Promise(function(t){setTimeout(t,100)})}return this.isTranslating=!1,{type:"translation-complete",payload:{results:s,successCount:r,failureCount:i}}}catch(t){throw this.isTranslating=!1,t}},n.prototype.handleApplyTranslation=async function(t){try{return await this.figmaService.applyTranslation(t.nodeId,t.translatedText,t.mode),{type:"apply-result",payload:{success:!0}}}catch(t){return{type:"apply-result",payload:{success:!1,error:t.message}}}},n.prototype.handleTestEngine=async function(t){try{const e=await this.translationEngine.testConnection(t.engine,t.config);return{type:"engine-test-result",payload:{engine:t.engine,success:e,error:e?null:"Connection test failed"}}}catch(e){return{type:"engine-test-result",payload:{engine:t.engine,success:!1,error:e.message}}}},n.prototype.getEngineConfig=function(t){return{openai:{apiKey:"YOUR_OPENAI_API_KEY",model:"gpt-3.5-turbo-instruct"},gemini:{apiKey:"YOUR_GEMINI_API_KEY",model:"gemini-pro"}}[t]||{}},n.prototype.postMessage=function(t){figma.ui.postMessage(t)},a.prototype.initialize=async function(){console.log("Initializing production plugin..."),this.setupUI(),this.setupMessageHandling(),this.setupEventListeners(),this.postMessage({type:"plugin-ready",payload:{version:"1.0.0",selection:this.figmaService.getSelectionInfo()}}),console.log("Production plugin initialized successfully")},a.prototype.setupUI=function(){figma.showUI(__html__,{width:380,height:600,title:"Advanced Translator"})},a.prototype.setupMessageHandling=function(){const t=this;figma.ui.onmessage=async function(e){try{console.log("Received message:",e.type);const n=await t.messageHandler.handleMessage(e);n&&t.postMessage(n)}catch(e){console.error("Message handling error:",e),t.postMessage({type:"error",payload:{error:e.message}})}}},a.prototype.setupEventListeners=function(){const t=this;figma.on("selectionchange",function(){const e=t.figmaService.getSelectionInfo();t.postMessage({type:"selection-changed",payload:e})}),figma.on("currentpagechange",function(){t.postMessage({type:"page-changed",payload:{pageId:figma.currentPage.id,pageName:figma.currentPage.name}})}),figma.on("close",function(){console.log("Plugin closing...")})},a.prototype.postMessage=function(t){figma.ui.postMessage(t),console.log("Sent message:",t.type)},async function(){try{const t=new a;await t.initialize()}catch(t){o(t,"main initialization")}}().catch(function(t){o(t,"default startup")}),console.log("Production plugin script loaded")})();
//# sourceMappingURL=code.js.map