<!doctype html><html><head><meta charset="utf-8"><title>TP Translator</title><style>* { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      font-size: 13px;
      background: #ffffff;
      color: #1a1a1a;
      height: 100vh;
      line-height: 1.4;
    }
    
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      max-width: 380px;
      margin: 0 auto;
    }
    
    /* Header */
    .header {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 20px 12px;
      flex-shrink: 0;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .logo-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    
    .logo-text {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .settings-btn {
      background: none;
      border: none;
      padding: 6px;
      border-radius: 4px;
      cursor: pointer;
      color: #6b7280;
      font-size: 16px;
    }
    
    .settings-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    .settings-btn.active {
      background: #e0e7ff;
      color: #4338ca;
    }
    
    /* Navigation */
    .nav-tabs {
      display: flex;
      background: #f9fafb;
      border-radius: 8px;
      padding: 2px;
      gap: 2px;
    }
    
    .nav-tab {
      flex: 1;
      background: none;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #6b7280;
    }
    
    .nav-tab.active {
      background: #ffffff;
      color: #1a1a1a;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .nav-tab:hover:not(.active) {
      color: #374151;
    }
    
    /* Content */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    /* Settings Modal - å¼ºåˆ¶è®¾ç½®ï¼Œè„±ç¦»çˆ¶å®¹å™¨é™åˆ¶ */
    .settings-modal {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      background: rgba(0, 0, 0, 0.5) !important;
      display: none;
      align-items: center !important;
      justify-content: center !important;
      z-index: 1000 !important;
      padding: 20px !important;
      box-sizing: border-box !important;
      /* é‡è¦ï¼šè„±ç¦»çˆ¶å®¹å™¨çš„max-widthé™åˆ¶ */
      width: 100vw !important;
      max-width: none !important;
    }
    
    .settings-modal.active {
      display: flex;
    }
    
    .settings-content {
      background: white;
      border-radius: 12px;
      width: 90% !important;
      max-width: 800px !important;
      min-width: 650px !important;
      max-height: 90vh !important;
      min-height: 550px !important;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      overflow: hidden;
      /* ç¡®ä¿è„±ç¦»çˆ¶å®¹å™¨é™åˆ¶ */
      position: relative !important;
      z-index: 1001 !important;
    }
    
    .settings-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .settings-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }
    
    .close-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    /* Settings Tabs */
    .settings-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
      flex-shrink: 0;
    }
    
    .settings-tab {
      flex: 1;
      background: none;
      border: none;
      padding: 16px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .settings-tab.active {
      color: #4338ca;
      border-bottom-color: #4338ca;
      background: white;
    }
    
    .settings-tab:hover:not(.active) {
      color: #374151;
      background: #f3f4f6;
    }
    
    .settings-body {
      padding: 20px 24px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
    
    .settings-section {
      margin-bottom: 32px;
    }
    
    .settings-section:last-child {
      margin-bottom: 0;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-icon {
      font-size: 16px;
    }
    
    /* Form Groups */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .form-col {
      flex: 1;
    }
    
    /* Inputs */
    .input, .select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      background: #ffffff;
      transition: border-color 0.2s ease;
    }
    
    .input:focus, .select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .input::placeholder {
      color: #9ca3af;
    }
    
    /* Engine Cards */
    .engine-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }
    
    .engine-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .engine-card.enabled {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .engine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .engine-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .engine-logo {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      font-weight: 600;
    }
    
    .engine-logo.openai {
      background: linear-gradient(135deg, #00a67e 0%, #00d4aa 100%);
    }
    
    .engine-logo.gemini {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    }
    
    .engine-details h4 {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .engine-details p {
      font-size: 12px;
      color: #6b7280;
    }
    
    .engine-toggle {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    
    .engine-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #10b981;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .engine-config {
      display: none;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    
    .engine-config.active {
      display: block;
    }
    
    .engine-config.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    /* Selection Info */
    .selection-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .selection-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #667eea;
      line-height: 1.2;
    }
    
    .stat-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      margin-top: 2px;
    }
    
    .selection-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Buttons */
    .btn {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-decoration: none;
      white-space: nowrap;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary:hover {
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    .btn-full {
      width: 100%;
    }
    
    .btn-test {
      background: #3b82f6;
      color: white;
      padding: 8px 16px;
      font-size: 12px;
    }
    
    .btn-test:hover {
      background: #2563eb;
    }
    
    .btn-test:disabled {
      background: #9ca3af;
    }
    
    .btn-warning {
      background: #f59e0b;
      color: white;
      border: 1px solid #d97706;
    }
    
    .btn-warning:hover {
      background: #d97706;
      border-color: #b45309;
    }
    
    .btn-warning:disabled {
      background: #9ca3af;
      border-color: #6b7280;
    }
    
    /* Font Mapping */
    .font-mapping-section {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .font-mapping-header {
      background: #f9fafb;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .font-mapping-title {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }
    
    .font-mapping-content {
      padding: 16px;
      display: none;
    }
    
    .font-mapping-content.active {
      display: block;
    }
    
    .font-weight-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .font-weight-label {
      width: 70px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }
    
    .font-arrow {
      color: #9ca3af;
      font-size: 12px;
    }
    
    /* Progress */
    .progress-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: none;
    }
    
    .progress-section.active {
      display: block;
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .progress-title {
      font-size: 13px;
      font-weight: 500;
      color: #374151;
    }
    
    .progress-percentage {
      font-size: 12px;
      color: #6b7280;
    }
    
    .progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    .progress-status {
      font-size: 12px;
      color: #64748b;
    }
    
    /* Results */
    .results-section {
      display: none;
    }
    
    .results-section.active {
      display: block;
    }
    
    .result-item {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    
    .result-item:hover {
      border-color: #d1d5db;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .result-item.success {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .result-item.error {
      border-color: #ef4444;
      background: #fef2f2;
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .result-index {
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
    }
    
    .result-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .result-status.success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .result-status.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .result-text {
      margin-bottom: 8px;
    }
    
    .result-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      margin-bottom: 4px;
    }
    
    .result-content {
      background: #f8fafc;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      font-size: 13px;
      line-height: 1.4;
      word-break: break-word;
    }
    
    .result-content.error {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b;
    }
    
    .result-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }
    
    .apply-status {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .apply-status.applied {
      background: #d1fae5;
      color: #065f46;
    }
    
    .apply-status.not-applied {
      background: #fef3c7;
      color: #92400e;
    }
    
    /* ç°ä»£åŒ–é€šçŸ¥ç³»ç»Ÿ */
    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      padding: 16px 20px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      z-index: 1100;
      display: none;
      max-width: 320px;
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .notification.success {
      background: rgba(16, 185, 129, 0.9);
      color: #ffffff;
      border-color: rgba(16, 185, 129, 0.2);
    }
    
    .notification.success::before {
      content: 'âœ“ ';
      font-weight: bold;
    }
    
    .notification.error {
      background: rgba(239, 68, 68, 0.9);
      color: #ffffff;
      border-color: rgba(239, 68, 68, 0.2);
    }
    
    .notification.error::before {
      content: 'âœ• ';
      font-weight: bold;
    }
    
    .notification.info {
      background: rgba(59, 130, 246, 0.9);
      color: #ffffff;
      border-color: rgba(59, 130, 246, 0.2);
    }
    
    .notification.info::before {
      content: 'â„¹ ';
      font-weight: bold;
    }
    
    .notification.active {
      display: block;
      animation: slideInBounce 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .notification.fade-out {
      animation: fadeOut 0.3s ease-out forwards;
    }
    
    @keyframes slideInBounce {
      0% {
        transform: translateX(100%) scale(0.8);
        opacity: 0;
      }
      60% {
        transform: translateX(-10px) scale(1.05);
        opacity: 0.8;
      }
      100% {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
    }
    
    @keyframes fadeOut {
      from {
        transform: translateX(0) scale(1);
        opacity: 1;
      }
      to {
        transform: translateX(100%) scale(0.9);
        opacity: 0;
      }
    }
    
    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    
    .empty-icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .empty-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }
    
    .empty-description {
      font-size: 12px;
      line-height: 1.5;
    }
    
    /* Connection Status */
    .connection-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .connection-status.connected {
      background: #d1fae5;
      color: #065f46;
    }
    
    .connection-status.disconnected {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .connection-status.connecting {
      background: #fef3c7;
      color: #92400e;
    }
    
    /* Settings Footer */
    .settings-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      border-radius: 0 0 12px 12px;
    }
    
    .settings-version {
      font-size: 12px;
      color: #6b7280;
    }
    
    .settings-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Translation Memory */
    .memory-item {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .memory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .memory-langs {
      font-size: 11px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .memory-actions {
      display: flex;
      gap: 4px;
    }
    
    .memory-text {
      font-size: 12px;
      line-height: 1.4;
    }
    
    .memory-original {
      color: #374151;
      margin-bottom: 4px;
    }
    
    .memory-translated {
      color: #059669;
    }
    
    /* è¯åº“æ ·å¼ */
    .glossary-term-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      margin-bottom: 8px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .term-content {
      display: flex;
      align-items: center;
      flex: 1;
      gap: 12px;
    }
    
    .term-source {
      font-weight: 500;
      color: #374151;
      background: #e5e7eb;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .term-arrow {
      color: #6b7280;
      font-weight: 500;
    }
    
    .term-target {
      font-weight: 500;
      color: #059669;
      background: #d1fae5;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
      cursor: text;
      transition: all 0.2s ease;
    }
    
    .term-source:hover, .term-target:hover {
      background-color: rgba(255, 255, 255, 0.5);
    }
    
    .term-source:focus, .term-target:focus {
      outline: 2px solid #007bff;
      outline-offset: 1px;
    }
    
    .term-actions {
      display: flex;
      gap: 4px;
    }
    
    .btn-icon-edit {
      color: #f59e0b;
    }
    
    .btn-icon-edit:hover {
      background: #fef3c7;
      border-color: #f59e0b;
    }
    
    .btn-icon-delete {
      color: #ef4444;
    }
    
    .btn-icon-delete:hover {
      background: #fee2e2;
      border-color: #ef4444;
    }
    
    /* è®¾ç½®é¡µé¢å¯¼èˆªæ ·å¼ */
    .settings-nav {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }
    
    .nav-back-btn {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .nav-back-btn:hover {
      background: #e9ecef;
    }
    
    .nav-breadcrumb {
      font-weight: 600;
      font-size: 18px;
      color: #343a40;
    }
    
    /* è®¾ç½®èœå•æ ·å¼ */
    .settings-menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 16px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: white;
    }
    
    .menu-item:hover {
      border-color: #007bff;
      background: #f8f9ff;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.1);
    }
    
    .menu-icon {
      font-size: 24px;
      margin-right: 16px;
      min-width: 32px;
      text-align: center;
    }
    
    .menu-content {
      flex: 1;
    }
    
    .menu-title {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #343a40;
    }
    
    .menu-desc {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: #6c757d;
    }
    
    .menu-arrow {
      color: #6c757d;
      font-size: 18px;
      margin-left: 12px;
    }
    
    /* Promptè®¾ç½®æ ·å¼ */
    .prompt-display {
      margin-bottom: 24px;
    }
    
    .prompt-label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #495057;
    }
    
    .prompt-content {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .base-prompt {
      color: #495057;
      background: #e9ecef;
    }
    
    .constraint-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .prompt-preview {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 12px;
    }
    
    .prompt-preview-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    /* è¿‡æ»¤å™¨æ ·å¼ */
    .filter-group {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e9ecef;
    }
    
    .filter-group:last-child {
      border-bottom: none;
    }
    
    .filter-group h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #495057;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .checkbox-label input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .checkmark {
      margin-left: 8px;
    }
    
    .filter-test {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 16px;
    }
    
    .filter-test-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.4;
    }
    
    .filter-test-result.passed {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    
    .filter-test-result.failed {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    /* é€šç”¨è¡¨å•æ ·å¼å¢å¼º */
    .textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    
    .textarea:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      outline: none;
    }
    
    .settings-container {
      position: relative;
      height: calc(100% - 140px);
      min-height: 400px !important;
      overflow: hidden;
      flex: 1;
    }
    
    .settings-page {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 20px;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      background: white;
    }
    
    .settings-page.active {
      transform: translateX(0);
    }
    
    /* ç¡®ä¿è®¾ç½®æ¨¡æ€æ¡†åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æœ‰é€‚å½“çš„å¤§å° */
    @media (max-width: 900px) {
      .settings-content {
        width: 95% !important;
        min-width: 400px !important;
        max-width: 90vw !important;
        min-height: 450px !important;
      }
    }
    
    @media (min-width: 901px) {
      .settings-content {
        width: 85% !important;
        max-width: 900px !important;
        min-width: 750px !important;
        min-height: 600px !important;
      }
    }
    
    /* å¼ºåˆ¶è®¾ç½®é¡µé¢å†…å®¹æ»šåŠ¨ */
    .settings-page {
      max-height: 100% !important;
      overflow-y: auto !important;
    }
    
    .settings-page.slide-left {
      transform: translateX(-100%);
    }
    
    /* çº¦æŸæ¡ç›®æ ·å¼ */
    .constraint-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      margin-bottom: 8px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .constraint-content {
      display: flex;
      align-items: center;
      flex: 1;
      gap: 12px;
    }
    
    .constraint-source {
      font-weight: 500;
      color: #374151;
      background: #e5e7eb;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .constraint-arrow {
      color: #6b7280;
      font-weight: 500;
    }
    
    .constraint-target {
      font-weight: 500;
      color: #7c3aed;
      background: #ede9fe;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .constraint-type {
      font-size: 11px;
      color: #6b7280;
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    /* çº¦æŸæ¨¡æ€æ¡†æ ·å¼ */
    .constraint-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .constraint-modal {
      background: white;
      border-radius: 12px;
      width: 500px;
      max-width: 90vw;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .constraint-modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .constraint-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: background-color 0.2s;
    }
    
    .modal-close:hover {
      background: #f3f4f6;
    }
    
    .constraint-modal-body {
      padding: 24px;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .constraint-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .constraint-conflicts {
      margin-top: 16px;
    }
    
    .constraint-warning {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      border-radius: 6px;
      padding: 12px;
      font-size: 14px;
      color: #92400e;
    }
    
    /* ç°ä»£åŒ–å›¾æ ‡æŒ‰é’®æ ·å¼ */
    .btn-icon {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      margin: 0 3px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }
    
    .btn-icon:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-icon:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-icon-copy {
      color: #3b82f6;
    }
    
    .btn-icon-copy:hover {
      background: #dbeafe;
      border-color: #3b82f6;
    }
    
    .btn-icon-glossary {
      color: #10b981;
    }
    
    .btn-icon-glossary:hover {
      background: #d1fae5;
      border-color: #10b981;
    }
    
    .btn-icon-locate {
      color: #8b5cf6;
    }
    
    .btn-icon-locate:hover {
      background: #ede9fe;
      border-color: #8b5cf6;
    }
    
    .btn-icon-batch {
      color: #f59e0b;
    }
    
    .btn-icon-batch:hover {
      background: #fef3c7;
      border-color: #f59e0b;
    }
    
    /* å…¨å±€æ“ä½œåŒºåŸŸæ ·å¼ */
    .results-global-actions {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .results-global-actions h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
    }
    
    .global-actions-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .global-actions-buttons .btn {
      font-size: 13px;
      padding: 6px 12px;
    }
    
    .results-list h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    /* å¯ç¼–è¾‘ç¿»è¯‘å†…å®¹æ ·å¼ */
    .result-content-editable {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      min-height: 24px;
      line-height: 1.5;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: text;
      font-family: inherit;
      font-size: 14px;
    }
    
    .result-content-editable:hover {
      background: #ffffff;
      border-color: #94a3b8;
    }
    
    .result-content-editable:focus {
      outline: none;
      background: #ffffff;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 4px 12px rgba(0, 0, 0, 0.05);
      transform: translateY(-1px);
    }
    
    .result-content-editable:empty:before {
      content: 'Click to edit translation...';
      color: #94a3b8;
      font-style: italic;
    }
    
    .result-content-editable.editing {
      border-color: #10b981;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1), 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .result-content-editable:hover:not(.editing) {
      cursor: text;
      border-color: #6b7280;
    }
    
    .result-content-editable:hover:not(.editing):after {
      content: 'âœï¸ ç‚¹å‡»ç¼–è¾‘';
      position: absolute;
      top: -25px;
      right: 0;
      font-size: 11px;
      color: #6b7280;
      background: #f9fafb;
      padding: 2px 6px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0.8;
    }
    
    /* SF Symbolsæµ‹è¯•åŒºåŸŸæ ·å¼ */
    #filter-test-input {
      font-family: -apple-system, BlinkMacSystemFont, SF Pro Display, SF Pro Text, Helvetica Neue, Arial, sans-serif !important;
      font-feature-settings: normal !important;
      text-rendering: optimizeLegibility !important;
      -webkit-font-smoothing: antialiased !important;
      letter-spacing: normal !important;
    }
    
    .filter-test-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      font-weight: 500;
      white-space: pre-wrap;
      font-family: -apple-system, BlinkMacSystemFont, SF Pro Display, SF Pro Text, Helvetica Neue, Arial, sans-serif;
    }
    
    .filter-test-result.passed {
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      color: #166534;
    }
    
    .filter-test-result.failed {
      background: #fee2e2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }</style></head><body><div id="root"><div class="app"><header class="header"><div class="logo-section"><div class="logo"><div class="logo-icon">ğŸ”Œ</div><span class="logo-text">TP Translator</span></div><div class="header-actions"><span class="connection-status" id="connection-status">è¿æ¥ä¸­</span> <button class="settings-btn" id="settings-btn" onclick="ui.toggleSettings()" title="è®¾ç½®">âš™ï¸</button></div></div><div class="nav-tabs"><button class="nav-tab active" onclick="ui.switchTab('home')">é¦–é¡µ</button> <button class="nav-tab" onclick="ui.switchTab('translate')">ç¿»è¯‘ç»“æœ</button></div></header><div class="content"><div class="page active" id="home-page"><div class="form-group"><label class="form-label">é€‰ä¸­å†…å®¹</label><div class="selection-card"><div class="selection-stats"><div class="stat-item"><span class="stat-value" id="total-nodes">0</span> <span class="stat-label">æ€»æ•°</span></div><div class="stat-item"><span class="stat-value" id="text-nodes">0</span> <span class="stat-label">æ–‡æœ¬èŠ‚ç‚¹</span></div></div><div class="selection-actions"><button class="btn btn-secondary btn-small" onclick="ui.refreshSelection()">ğŸ”„ åˆ·æ–°</button> <button class="btn btn-secondary btn-small" onclick="ui.selectAllText()">ğŸ“ é€‰æ‹©æ‰€æœ‰æ–‡æœ¬</button></div></div></div><div class="form-group"><label class="form-label">ç¿»è¯‘å¼•æ“</label><div class="form-row"><div class="form-col"><select class="select" id="engine"><option value="">é€‰æ‹©å¼•æ“...</option></select></div><div class="form-col"><select class="select" id="model-select" style="display: none;"><option value="">é€‰æ‹©æ¨¡å‹...</option></select></div></div><div class="form-row" id="api-key-row" style="display: none; margin-top: 8px;"><div class="form-col"><input type="password" class="input" id="api-key" placeholder="è¾“å…¥APIå¯†é’¥"></div><div class="form-col" style="flex: 0 0 auto;"><button class="btn btn-secondary btn-small" onclick="ui.openEngineSettings()">âš™ï¸ é…ç½®</button></div></div></div><div class="form-group"><label class="form-label">è¯­è¨€</label><div class="form-row"><div class="form-col"><select class="select" id="source-lang"><option value="auto">è‡ªåŠ¨è¯†åˆ«</option><option value="en">è‹±è¯­</option><option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option><option value="ja">æ—¥è¯­</option><option value="ko">éŸ©è¯­</option><option value="fr">æ³•è¯­</option><option value="de">å¾·è¯­</option><option value="es">è¥¿ç­ç‰™è¯­</option></select></div><div class="form-col"><select class="select" id="target-lang"><option value="en">è‹±è¯­</option><option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option><option value="ja">æ—¥è¯­</option><option value="ko">éŸ©è¯­</option><option value="fr">æ³•è¯­</option><option value="de">å¾·è¯­</option><option value="es">è¥¿ç­ç‰™è¯­</option></select></div></div></div><div class="form-group"><label class="form-label">è¾“å‡ºæ¨¡å¼</label> <select class="select" id="output-mode"><option value="replace">æ›¿æ¢åŸæ–‡æœ¬</option><option value="beside">åœ¨æ—è¾¹æ˜¾ç¤º</option><option value="newFrame">åœ¨æ–°æ¡†æ¶ä¸­æ˜¾ç¤º</option><option value="newPage">åœ¨æ–°é¡µé¢ä¸­æ˜¾ç¤º</option></select></div><div class="font-mapping-section"><div class="font-mapping-header"><span class="font-mapping-title">å­—ä½“æ˜ å°„</span> <label class="engine-toggle"><input type="checkbox" id="font-mapping-enabled"> <span class="toggle-slider"></span></label></div><div class="font-mapping-content" id="font-mapping-content"><div class="font-weight-row"><span class="font-weight-label">Regular</span> <select class="select" style="flex: 1;"><option>Inter Regular</option><option>Roboto Regular</option><option>Arial Regular</option></select> <span class="font-arrow">â†’</span> <select class="select" style="flex: 1;"><option>Noto Sans SC Regular</option><option>PingFang SC Regular</option><option>Source Han Sans SC Regular</option></select></div><div class="font-weight-row"><span class="font-weight-label">Medium</span> <select class="select" style="flex: 1;"><option>Inter Medium</option><option>Roboto Medium</option><option>Arial Medium</option></select> <span class="font-arrow">â†’</span> <select class="select" style="flex: 1;"><option>Noto Sans SC Medium</option><option>PingFang SC Medium</option><option>Source Han Sans SC Medium</option></select></div><div class="font-weight-row"><span class="font-weight-label">Bold</span> <select class="select" style="flex: 1;"><option>Inter Bold</option><option>Roboto Bold</option><option>Arial Bold</option></select> <span class="font-arrow">â†’</span> <select class="select" style="flex: 1;"><option>Noto Sans SC Bold</option><option>PingFang SC Bold</option><option>Source Han Sans SC Bold</option></select></div></div></div><button class="btn btn-primary btn-full" id="translate-btn" onclick="ui.startTranslation()" disabled="disabled">ğŸš€ ç¿»è¯‘</button><div class="progress-section" id="progress-section"><div class="progress-header"><span class="progress-title">ç¿»è¯‘ä¸­...</span> <span class="progress-percentage" id="progress-percentage">0%</span></div><div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div><div class="progress-status" id="progress-status">åˆå§‹åŒ–ä¸­...</div></div></div><div class="page" id="translate-page"><div class="results-section active" id="results-section"><div class="form-group"><label class="form-label">ç¿»è¯‘ç»“æœ</label><div id="results-container"><div class="empty-state"><div class="empty-icon">ğŸ“„</div><div class="empty-title">è¿˜æ²¡æœ‰ç¿»è¯‘ç»“æœ</div><div class="empty-description">åˆ‡æ¢åˆ°é¦–é¡µå¼€å§‹ç¿»è¯‘</div></div></div></div></div></div></div></div><div class="settings-modal" id="settings-modal"><div class="settings-content"><div class="settings-header"><div class="settings-nav"><button class="nav-back-btn" id="nav-back-btn" onclick="ui.navigateSettings('back')" style="display: none;">â† Back</button><div class="nav-breadcrumb" id="nav-breadcrumb">Settings</div></div><button class="close-btn" onclick="ui.closeSettings()">Ã—</button></div><div class="settings-container" id="settings-container"><!-- Settings Home Page --><div class="settings-page active" id="settings-home"><div class="settings-menu"><div class="menu-item" onclick="ui.navigateSettings('engines-settings')"><div class="menu-icon">ğŸ”‘</div><div class="menu-content"><h3 class="menu-title">Translation Engines</h3><p class="menu-desc">Configure OpenAI and Gemini API settings</p></div><div class="menu-arrow">â†’</div></div><div class="menu-item" onclick="ui.navigateSettings('prompt-settings')"><div class="menu-icon">ğŸ’­</div><div class="menu-content"><h3 class="menu-title">Advanced Prompts</h3><p class="menu-desc">Customize translation prompts and constraints</p></div><div class="menu-arrow">â†’</div></div><div class="menu-item" onclick="ui.navigateSettings('glossary-settings')"><div class="menu-icon">ğŸ“š</div><div class="menu-content"><h3 class="menu-title">Glossary & Terms</h3><p class="menu-desc">Manage translation glossary and fixed terms</p></div><div class="menu-arrow">â†’</div></div><div class="menu-item" onclick="ui.navigateSettings('memories-settings')"><div class="menu-icon">ğŸ§ </div><div class="menu-content"><h3 class="menu-title">Translation Memory</h3><p class="menu-desc">Review and manage translation history</p></div><div class="menu-arrow">â†’</div></div><div class="menu-item" onclick="ui.navigateSettings('filters-settings')"><div class="menu-icon">ğŸ”</div><div class="menu-content"><h3 class="menu-title">Content Filters</h3><p class="menu-desc">Configure what content to skip during translation</p></div><div class="menu-arrow">â†’</div></div><div class="menu-item" onclick="ui.navigateSettings('general-settings')"><div class="menu-icon">âš™ï¸</div><div class="menu-content"><h3 class="menu-title">General Settings</h3><p class="menu-desc">Language preferences and general options</p></div><div class="menu-arrow">â†’</div></div></div></div>

<!-- Translation Engines Page --><div class="settings-page" id="engines-settings"><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ”‘</span> Translation Engines</h3><div class="engine-card" id="openai-card"><div class="engine-header"><div class="engine-info"><div class="engine-logo openai">AI</div><div class="engine-details"><h4>OpenAI</h4><p>GPT-3.5 & GPT-4 models</p></div></div><label class="engine-toggle"><input type="checkbox" id="openai-enabled"> <span class="toggle-slider"></span></label></div><div class="engine-config" id="openai-config"><div class="form-group"><label class="form-label">API Key</label> <input type="password" class="input" id="openai-key" placeholder="sk-..."></div><div class="form-group"><label class="form-label">Model</label> <select class="select" id="openai-model"><option value="gpt-3.5-turbo-instruct">GPT-3.5 Turbo Instruct</option><option value="gpt-4">GPT-4</option><option value="gpt-4-turbo">GPT-4 Turbo</option></select></div><button class="btn btn-test" onclick="ui.testEngine('openai')" id="openai-test-btn">Test Connection</button></div></div><div class="engine-card" id="gemini-card"><div class="engine-header"><div class="engine-info"><div class="engine-logo gemini">G</div><div class="engine-details"><h4>Google Gemini</h4><p>Gemini Pro & Flash models</p></div></div><label class="engine-toggle"><input type="checkbox" id="gemini-enabled"> <span class="toggle-slider"></span></label></div><div class="engine-config" id="gemini-config"><div class="form-group"><label class="form-label">API Key</label> <input type="password" class="input" id="gemini-key" placeholder="AIza..."></div><div class="form-group"><label class="form-label">Model</label> <select class="select" id="gemini-model"><option value="gemini-pro">Gemini Pro</option><option value="gemini-1.5-pro">Gemini 1.5 Pro</option><option value="gemini-1.5-flash">Gemini 1.5 Flash</option></select></div><button class="btn btn-test" onclick="ui.testEngine('gemini')" id="gemini-test-btn">Test Connection</button></div></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸŒ</span> Default Languages</h3><div class="form-row"><div class="form-col"><label class="form-label">Default Target Language</label> <select class="select" id="default-target-lang"><option value="en">è‹±è¯­</option><option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option><option value="ja">æ—¥è¯­</option><option value="ko">éŸ©è¯­</option></select></div></div></div></div><!-- Advanced Prompt Page --><div class="settings-page" id="prompt-settings"><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ’­</span> Base Prompt System</h3><div class="prompt-display"><div class="prompt-label">Current Base Prompt (Read-only)</div><div class="prompt-content base-prompt" id="base-prompt-display">Loading base prompt...</div></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ¯</span> Project Context</h3><div class="form-group"><label class="form-label">Project Type</label><select class="select" id="project-type"><option value="mobile-app">Mobile App Interface</option><option value="web-admin">Web Admin Panel</option><option value="device-display">Device Display</option><option value="marketing">Marketing Material</option><option value="custom">Custom Project</option></select></div><div class="form-row"><div class="form-col"><label class="form-label">Industry</label><input type="text" class="input" id="project-industry" placeholder="e.g., E-commerce, Healthcare"></div><div class="form-col"><label class="form-label">Target Audience</label><select class="select" id="target-audience"><option value="general">General Users</option><option value="technical">Technical Users</option><option value="enterprise">Enterprise Users</option><option value="admin">Administrators</option></select></div></div><div class="form-group"><label class="form-label">Language Style</label><select class="select" id="language-style"><option value="professional">Professional</option><option value="friendly">Friendly</option><option value="concise">Concise</option><option value="detailed">Detailed</option></select></div><div class="form-group"><label class="form-label">Special Instructions</label><textarea class="textarea" id="special-instructions" rows="3" placeholder="Any specific requirements for this project..."></textarea></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ”’</span> Translation Constraints</h3><div class="constraint-controls"><button class="btn btn-secondary btn-small" onclick="ui.addConstraint()">+ Add Constraint</button><button class="btn btn-secondary btn-small" onclick="ui.importConstraints()">Import Rules</button></div><div id="constraints-list"><div class="empty-state"><div class="empty-icon">ğŸ”’</div><div class="empty-title">No constraints defined</div><div class="empty-description">Add constraints to ensure consistent translation of specific terms</div></div></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ”</span> Prompt Preview</h3><div class="prompt-preview-controls"><input type="text" class="input" id="preview-text" placeholder="Enter test text to preview prompt..." style="margin-bottom: 10px;"><button class="btn btn-primary btn-small" onclick="ui.previewPrompt()">Generate Preview</button></div><div class="prompt-preview" id="prompt-preview-display">Enter test text above to see the final prompt that will be sent to the AI model.</div></div></div>

<!-- Content Filters Page --><div class="settings-page" id="filters-settings"><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ”</span> Smart Content Filtering</h3><div class="filter-group"><h4>Icon & Symbol Detection</h4><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="filter-sf-symbols" checked><span class="checkmark"></span>Skip SF Symbols and system icons</label></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="filter-font-icons" checked><span class="checkmark"></span>Skip font icons (FontAwesome, Material Icons, etc.)</label></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="filter-unicode-private" checked><span class="checkmark"></span>Skip private Unicode area characters</label></div></div><div class="filter-group"><h4>Empty Content Detection</h4><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="filter-empty-text" checked><span class="checkmark"></span>Skip pure whitespace content</label></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="filter-single-chars" checked><span class="checkmark"></span>Skip single character text (except CJK)</label></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="filter-placeholders"><span class="checkmark"></span>Skip placeholder text (Lorem ipsum, etc.)</label></div></div><div class="filter-group"><h4>Custom Filter Rules</h4><div class="form-group"><label class="form-label">Skip text matching patterns (one per line)</label><textarea class="textarea" id="custom-filter-patterns" rows="4" placeholder="^\\d+$&#10;^[A-Z]{2,3}$&#10;\\$\\{.*\\}"></textarea></div><div class="form-group"><label class="form-label">Skip text containing any of these words</label><input type="text" class="input" id="skip-words" placeholder="debug, test, placeholder (comma separated)"></div></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ§ª</span> Filter Testing</h3><div class="filter-test"><div class="form-group"><label class="form-label">Test Text</label><textarea class="textarea" id="filter-test-input" rows="3" placeholder="Enter text to test filtering..."></textarea></div><button class="btn btn-primary btn-small" onclick="ui.testFilters()">Test Filters</button><div class="filter-test-result" id="filter-test-result"></div></div></div></div>

<!-- General Settings Page --><div class="settings-page" id="general-settings"><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸŒ</span> Language Settings</h3><div class="form-row"><div class="form-col"><label class="form-label">Default Target Language</label><select class="select" id="general-default-target-lang"><option value="en">è‹±è¯­</option><option value="zh-CN">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option><option value="ja">æ—¥è¯­</option><option value="ko">éŸ©è¯­</option></select></div><div class="form-col"><label class="form-label">UI Language</label><select class="select" id="ui-language"><option value="en">è‹±è¯­</option><option value="zh-CN">ä¸­æ–‡</option></select></div></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">âš¡</span> Performance</h3><div class="form-group"><label class="form-label">Batch Size</label><select class="select" id="batch-size"><option value="1">1 (Slowest, most accurate)</option><option value="3" selected>3 (Recommended)</option><option value="5">5 (Faster)</option><option value="10">10 (Fastest, may hit rate limits)</option></select></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="enable-caching" checked><span class="checkmark"></span>Enable translation caching</label></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ”„</span> Auto Actions</h3><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="auto-apply-translations" checked><span class="checkmark"></span>Automatically apply translations to Figma</label></div><div class="form-group"><label class="checkbox-label"><input type="checkbox" id="auto-save-glossary"><span class="checkmark"></span>Auto-save successful translations to glossary</label></div></div></div>

<div class="settings-page" id="memories-settings"><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ§ </span> Translation Memory</h3><div class="form-group"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><span class="form-label">Recent Translations</span> <button class="btn btn-secondary btn-small" onclick="ui.clearMemories()">Clear All</button></div><div id="translation-memories"><div class="empty-state"><div class="empty-icon">ğŸ§ </div><div class="empty-title">No translation memories</div><div class="empty-description">Your recent translations will appear here</div></div></div></div></div></div><div class="settings-page" id="glossary-settings"><div class="settings-section"><h3 class="section-title"><span class="section-icon">ğŸ“š</span> Standard Glossary</h3><div class="form-group"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><span class="form-label">Add New Term</span></div><div class="form-row"><div class="form-col"><input type="text" class="input" id="glossary-source" placeholder="Source text (e.g., Hello)"></div><div class="form-col"><input type="text" class="input" id="glossary-target" placeholder="Target text (e.g., ä½ å¥½)"></div><div class="form-col" style="flex: 0 0 auto;"><button class="btn btn-primary btn-small" onclick="ui.addGlossaryTerm()">+ Add</button></div></div></div><div class="form-group"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><span class="form-label">Glossary Terms</span><div style="display: flex; gap: 8px;"><button class="btn btn-secondary btn-small" onclick="ui.clearGlossary()">Clear All</button></div></div><div id="glossary-terms"><div class="empty-state"><div class="empty-icon">ğŸ“š</div><div class="empty-title">No glossary terms</div><div class="empty-description">Add terms to ensure consistent translation</div></div></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">âš™ï¸</span> Glossary Settings</h3><div class="form-group"><label class="engine-toggle"><input type="checkbox" id="glossary-enabled" checked><span class="toggle-slider"></span></label><span style="margin-left: 12px;">Enable glossary matching during translation</span></div><div class="form-group"><label class="form-label">Match Sensitivity</label><select class="select" id="glossary-sensitivity"><option value="exact">Exact Match Only</option><option value="fuzzy" selected>Fuzzy Match (Recommended)</option><option value="partial">Partial Match</option></select></div></div></div></div><div class="settings-footer"><span class="settings-version">v2.2.1 ä¸­æ–‡ç‰ˆ</span><div class="settings-actions"><button class="btn btn-secondary" onclick="ui.closeSettings()">Cancel</button> <button class="btn btn-primary" onclick="ui.saveSettings()">Save Settings</button></div></div></div></div></div><div class="notification" id="notification"></div><script>console.log('TP Translator with Settings UI loading...');
    
    // Application state - ä¿®å¤é»˜è®¤å¼•æ“é—®é¢˜
    let appState = {
      connected: false,
      currentTab: 'home',
      currentSettingsTab: 'common',
      isTranslating: false,
      showingSettings: false,
      selection: { totalNodes: 0, textNodes: 0, nodeIds: [] },
      results: [],
      fontMappingEnabled: false,
      engines: {
        openai: { enabled: false, apiKey: '', model: 'gpt-3.5-turbo-instruct' },
        gemini: { enabled: true, apiKey: '', model: 'gemini-pro' }
      },
      settings: {
        defaultTargetLang: 'en'
      },
      translationMemories: [],
      glossary: {
        enabled: true,
        sensitivity: 'fuzzy',
        terms: []
      },
      
      // æ–°çš„é«˜çº§è®¾ç½®
      advancedPrompt: {
        projectType: 'mobile-app',
        industry: '',
        targetAudience: 'general',
        languageStyle: 'professional',
        specialInstructions: '',
        constraints: []
      },
      
      contentFilters: {
        skipSFSymbols: true,
        skipFontIcons: true,
        skipUnicodePrivate: true,
        skipEmptyText: true,
        skipSingleChars: true,
        skipPlaceholders: false,
        customPatterns: '',
        skipWords: ''
      },
      
      general: {
        uiLanguage: 'zh-CN',
        batchSize: 3,
        enableCaching: true,
        autoApplyTranslations: true,
        autoSaveGlossary: false
      },
      
      // è®¾ç½®å¯¼èˆªçŠ¶æ€
      settingsNavigation: {
        currentPage: 'settings-home',
        history: [],
        breadcrumb: 'Settings'
      },
      
      // æ’¤é”€åŠŸèƒ½çŠ¶æ€
      undoSystem: {
        history: [],
        maxHistory: 50,
        currentSessionId: null
      }
    };
    
    // UI Controller
    const ui = {
      // Tab switching
      switchTab(tabName) {
        console.log('Switching to tab:', tabName);
        appState.currentTab = tabName;
        
        // Update tab buttons
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update page content
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById(tabName + '-page').classList.add('active');
      },
      
      // Settings modal
      toggleSettings() {
        if (appState.showingSettings) {
          this.closeSettings();
        } else {
          this.showSettings();
        }
      },
      
      showSettings() {
        appState.showingSettings = true;
        document.getElementById('settings-modal').classList.add('active');
        document.getElementById('settings-btn').classList.add('active');
        this.loadSettings();
      },
      
      closeSettings() {
        appState.showingSettings = false;
        document.getElementById('settings-modal').classList.remove('active');
        document.getElementById('settings-btn').classList.remove('active');
      },
      
      switchSettingsTab(tabName) {
        appState.currentSettingsTab = tabName;
        
        // Update tab buttons
        document.querySelectorAll('.settings-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update page content
        document.querySelectorAll('.settings-page').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById(tabName + '-settings').classList.add('active');
        
        // Initialize specific tab content
        if (tabName === 'glossary') {
          this.renderGlossaryTerms();
          // Set current values
          document.getElementById('glossary-enabled').checked = appState.glossary.enabled;
          document.getElementById('glossary-sensitivity').value = appState.glossary.sensitivity;
        }
      },
      
      // Engine management
      toggleEngine(engine, enabled) {
        appState.engines[engine].enabled = enabled;
        const card = document.getElementById(engine + '-card');
        const config = document.getElementById(engine + '-config');
        
        if (enabled) {
          card.classList.add('enabled');
          config.classList.add('active');
        } else {
          card.classList.remove('enabled');
          config.classList.remove('active');
        }
        
        this.updateEngineDropdown();
      },
      
      updateEngineDropdown() {
        const select = document.getElementById('engine');
        select.innerHTML = '';
        
        // å¼ºåˆ¶æ˜¾ç¤ºGeminiå¼•æ“ï¼ˆä¸ç®¡enabledçŠ¶æ€ï¼‰
        const geminiOption = document.createElement('option');
        geminiOption.value = 'gemini';
        geminiOption.textContent = 'Google Gemini (gemini-pro)';
        geminiOption.selected = true; // é»˜è®¤é€‰ä¸­
        select.appendChild(geminiOption);
        
        // åªæœ‰å¯ç”¨OpenAIæ—¶æ‰æ·»åŠ 
        if (appState.engines.openai.enabled) {
          const openaiOption = document.createElement('option');
          openaiOption.value = 'openai';
          openaiOption.textContent = 'OpenAI GPT';
          select.appendChild(openaiOption);
        }
        
        // å¦‚æœä¸‹æ‹‰æ¡†ä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤æç¤º
        if (select.children.length === 0) {
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Select Engine...';
          select.appendChild(defaultOption);
        }
        
        this.updateUI();
        this.updateEngineInterface();
      },

      updateEngineInterface() {
        const selectedEngine = document.getElementById('engine').value;
        const modelSelect = document.getElementById('model-select');
        const apiKeyRow = document.getElementById('api-key-row');
        const apiKeyInput = document.getElementById('api-key');

        if (!selectedEngine) {
          modelSelect.style.display = 'none';
          apiKeyRow.style.display = 'none';
          return;
        }

        // Show model select and API key input
        modelSelect.style.display = 'block';
        apiKeyRow.style.display = 'flex';

        // Populate model options
        modelSelect.innerHTML = '<option value="">é€‰æ‹©æ¨¡å‹...</option>';
        
        if (selectedEngine === 'openai') {
          const models = [
            { value: 'gpt-3.5-turbo-instruct', label: 'GPT-3.5 Turbo Instruct' },
            { value: 'gpt-4', label: 'GPT-4' },
            { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' }
          ];
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.value;
            option.textContent = model.label;
            modelSelect.appendChild(option);
          });
        } else if (selectedEngine === 'gemini') {
          const models = [
            { value: 'gemini-pro', label: 'Gemini Pro' },
            { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
            { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' }
          ];
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.value;
            option.textContent = model.label;
            modelSelect.appendChild(option);
          });
        }

        // Set current values from state
        const engineConfig = appState.engines[selectedEngine];
        if (engineConfig) {
          modelSelect.value = engineConfig.model;
          apiKeyInput.value = engineConfig.apiKey;
        }
      },

      openEngineSettings() {
        this.showSettings();
        // Auto-navigate to engines page
        setTimeout(() => {
          this.navigateSettings('engines-settings');
        }, 100);
      },
      
      // è®¾ç½®é¡µé¢å¯¼èˆªç³»ç»Ÿ
      navigateSettings(page) {
        console.log('Navigate to settings page:', page);
        
        if (page === 'back') {
          // è¿”å›ä¸Šä¸€é¡µ
          if (appState.settingsNavigation.history.length > 0) {
            const previousPage = appState.settingsNavigation.history.pop();
            this.navigateSettings(previousPage);
            return;
          } else {
            // è¿”å›ä¸»é¡µ
            page = 'settings-home';
          }
        }
        
        // æ›´æ–°å¯¼èˆªçŠ¶æ€
        if (page !== 'settings-home' && appState.settingsNavigation.currentPage !== page) {
          appState.settingsNavigation.history.push(appState.settingsNavigation.currentPage);
        }
        
        appState.settingsNavigation.currentPage = page;
        
        // æ›´æ–°é¢åŒ…å±‘
        const breadcrumbs = {
          'settings-home': 'Settings',
          'engines-settings': 'Settings > Translation Engines',
          'prompt-settings': 'Settings > Advanced Prompts',
          'glossary-settings': 'Settings > Glossary & Terms',
          'memories-settings': 'Settings > Translation Memory', 
          'filters-settings': 'Settings > Content Filters',
          'general-settings': 'Settings > General Settings'
        };
        
        appState.settingsNavigation.breadcrumb = breadcrumbs[page] || 'Settings';
        document.getElementById('nav-breadcrumb').textContent = appState.settingsNavigation.breadcrumb;
        
        // æ˜¾ç¤º/éšè—è¿”å›æŒ‰é’®
        const backBtn = document.getElementById('nav-back-btn');
        if (page === 'settings-home') {
          backBtn.style.display = 'none';
        } else {
          backBtn.style.display = 'block';
        }
        
        // åˆ‡æ¢é¡µé¢
        document.querySelectorAll('.settings-page').forEach(p => {
          p.classList.remove('active', 'slide-left');
        });
        
        const targetPage = document.getElementById(page);
        if (targetPage) {
          targetPage.classList.add('active');
          
          // åˆå§‹åŒ–é¡µé¢å†…å®¹
          this.initializeSettingsPage(page);
        }
      },
      
      // åˆå§‹åŒ–è®¾ç½®é¡µé¢å†…å®¹
      initializeSettingsPage(page) {
        switch (page) {
          case 'prompt-settings':
            this.loadBasePrompt();
            this.loadPromptSettings();
            break;
          case 'filters-settings':
            this.loadFilterSettings();
            break;
          case 'general-settings':
            this.loadGeneralSettings();
            break;
          case 'glossary-settings':
            this.renderGlossaryTerms();
            this.loadGlossarySettings();
            break;
        }
      },
      
      testEngine(engine) {
        const config = appState.engines[engine];
        if (!config.apiKey) {
          this.showNotification('Please enter API key first', 'error');
          return;
        }
        
        const testBtn = document.getElementById(engine + '-test-btn');
        testBtn.disabled = true;
        testBtn.textContent = 'Testing...';
        
        this.postMessage('test-engine', {
          engine: engine,
          config: { apiKey: config.apiKey, model: config.model }
        });
      },
      
      // Settings persistence
      loadSettings() {
        // Load engine settings
        Object.keys(appState.engines).forEach(engine => {
          const config = appState.engines[engine];
          document.getElementById(engine + '-enabled').checked = config.enabled;
          document.getElementById(engine + '-key').value = config.apiKey;
          document.getElementById(engine + '-model').value = config.model;
          
          this.toggleEngine(engine, config.enabled);
        });
        
        // Load other settings
        document.getElementById('default-target-lang').value = appState.settings.defaultTargetLang;
        
        // Load translation memories
        this.renderTranslationMemories();
      },
      
      // ä¿å­˜è®¾ç½®æ•°æ®ä½†ä¸å…³é—­è®¾ç½®é¡µé¢ï¼ˆç”¨äºè¯åº“ç­‰æ“ä½œï¼‰
      saveSettingsData() {
        // Save advanced prompt settings
        this.saveAdvancedPromptSettings();
        
        // Save content filter settings
        this.saveContentFilterSettings();
        
        // Save general settings
        this.saveGeneralSettings();
        
        // Persist to Figma storage
        this.postMessage('save-settings', {
          engines: appState.engines,
          settings: appState.settings,
          translationMemories: appState.translationMemories,
          glossary: appState.glossary,
          advancedPrompt: appState.advancedPrompt,
          contentFilters: appState.contentFilters,
          general: appState.general
        });
      },

      saveSettings() {
        // Save engine settings
        Object.keys(appState.engines).forEach(engine => {
          const enabledEl = document.getElementById(engine + '-enabled');
          const keyEl = document.getElementById(engine + '-key');
          const modelEl = document.getElementById(engine + '-model');
          
          if (enabledEl && keyEl && modelEl) {
            appState.engines[engine] = {
              enabled: enabledEl.checked,
              apiKey: keyEl.value.trim(),
              model: modelEl.value
            };
          }
        });
        
        // Save other settings
        const targetLangEl = document.getElementById('default-target-lang');
        if (targetLangEl) {
          appState.settings.defaultTargetLang = targetLangEl.value;
        }
        
        // Save glossary settings
        if (document.getElementById('glossary-enabled')) {
          appState.glossary.enabled = document.getElementById('glossary-enabled').checked;
        }
        if (document.getElementById('glossary-sensitivity')) {
          appState.glossary.sensitivity = document.getElementById('glossary-sensitivity').value;
        }
        
        // Update target language default
        const mainTargetLang = document.getElementById('target-lang');
        if (mainTargetLang) {
          mainTargetLang.value = appState.settings.defaultTargetLang;
        }
        
        this.updateEngineDropdown();
        
        // ä¿å­˜è®¾ç½®æ•°æ®
        this.saveSettingsData();
        
        // å…³é—­è®¾ç½®é¡µé¢å¹¶æ˜¾ç¤ºé€šçŸ¥
        this.closeSettings();
        this.showNotification('è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
      },
      
      // Translation memories
      addTranslationMemory(original, translated, sourceLang, targetLang, engine) {
        const memory = {
          id: Date.now(),
          original,
          translated,
          sourceLang,
          targetLang,
          engine,
          timestamp: new Date().toISOString()
        };
        
        appState.translationMemories.unshift(memory);
        // Keep only last 50 memories
        appState.translationMemories = appState.translationMemories.slice(0, 50);
        
        this.renderTranslationMemories();
        
        // Auto-save translation memories
        this.postMessage('save-settings', {
          translationMemories: appState.translationMemories
        });
      },
      
      renderTranslationMemories() {
        const container = document.getElementById('translation-memories');
        
        if (appState.translationMemories.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">ğŸ§ </div>
              <div class="empty-title">No translation memories</div>
              <div class="empty-description">Your recent translations will appear here</div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = appState.translationMemories.map(memory => `
          <div class="memory-item">
            <div class="memory-header">
              <span class="memory-langs">${memory.sourceLang} â†’ ${memory.targetLang}</span>
              <div class="memory-actions">
                <button class="btn btn-secondary btn-small" onclick="ui.reuseMemory('${memory.id}')">
                  Reuse
                </button>
                <button class="btn btn-secondary btn-small" onclick="ui.deleteMemory('${memory.id}')">
                  Ã—
                </button>
              </div>
            </div>
            <div class="memory-text">
              <div class="memory-original">${this.escapeHtml(memory.original)}</div>
              <div class="memory-translated">${this.escapeHtml(memory.translated)}</div>
            </div>
          </div>
        `).join('');
      },
      
      reuseMemory(memoryId) {
        const memory = appState.translationMemories.find(m => m.id == memoryId);
        if (memory) {
          document.getElementById('source-lang').value = memory.sourceLang;
          document.getElementById('target-lang').value = memory.targetLang;
          
          // Switch to engine if available
          if (appState.engines[memory.engine] && appState.engines[memory.engine].enabled) {
            document.getElementById('engine').value = memory.engine;
          }
          
          this.closeSettings();
          this.switchTab('home');
          this.showNotification('Translation settings applied', 'success');
        }
      },
      
      deleteMemory(memoryId) {
        appState.translationMemories = appState.translationMemories.filter(m => m.id != memoryId);
        this.renderTranslationMemories();
      },
      
      clearMemories() {
        if (confirm('Clear all translation memories?')) {
          appState.translationMemories = [];
          this.renderTranslationMemories();
          this.showNotification('Translation memories cleared', 'success');
        }
      },
      
      // Selection management
      refreshSelection() {
        console.log('Refreshing selection');
        this.postMessage('get-selection');
      },
      
      selectAllText() {
        console.log('Selecting all text in current page');
        this.postMessage('select-all-text');
      },
      
      // Translation
      startTranslation() {
        const engine = document.getElementById('engine').value;
        const model = document.getElementById('model-select').value;
        const apiKey = document.getElementById('api-key').value.trim();
        const sourceLang = document.getElementById('source-lang').value;
        const targetLang = document.getElementById('target-lang').value;
        const mode = document.getElementById('output-mode').value;
        
        if (!engine) {
          this.showNotification('Please select a translation engine', 'error');
          return;
        }
        
        if (!model) {
          this.showNotification('Please select a model', 'error');
          return;
        }
        
        if (!apiKey) {
          this.showNotification('Please enter API key', 'error');
          return;
        }
        
        if (appState.selection.textNodes === 0) {
          this.showNotification('Please select text nodes first', 'error');
          return;
        }
        
        console.log('Starting translation:', { engine, model, sourceLang, targetLang, mode });
        
        // Update engine config in state for future use
        appState.engines[engine].apiKey = apiKey;
        appState.engines[engine].model = model;
        
        appState.isTranslating = true;
        appState.results = [];
        appState.translationHistory = []; // é‡ç½®ç¿»è¯‘å†å²
        this.updateUI();
        
        // Show progress
        document.getElementById('progress-section').classList.add('active');
        
        // Switch to translate tab to show results
        this.switchTab('translate');
        document.querySelector('.nav-tab[onclick*="translate"]').classList.add('active');
        document.querySelector('.nav-tab[onclick*="home"]').classList.remove('active');
        
        this.postMessage('start-translation', {
          engine: engine,
          sourceLang: sourceLang,
          targetLang: targetLang,
          mode: mode,
          nodeIds: appState.selection.nodeIds,
          config: { apiKey: apiKey, model: model },
          glossary: appState.glossary,
          advancedPrompt: appState.advancedPrompt,
          contentFilters: appState.contentFilters,
          general: appState.general
        });
      },
      
      // Progress updates
      updateProgress(progress, status) {
        document.getElementById('progress-fill').style.width = progress + '%';
        document.getElementById('progress-percentage').textContent = Math.round(progress) + '%';
        document.getElementById('progress-status').textContent = status || 'Processing...';
      },
      
      // Results management
      addResult(result) {
        appState.results.push(result);
        this.renderResults();
        
        // Add to translation memory if successful
        if (result.status === 'success' && result.originalText && result.translatedText) {
          this.addTranslationMemory(
            result.originalText,
            result.translatedText,
            document.getElementById('source-lang').value,
            document.getElementById('target-lang').value,
            document.getElementById('engine').value
          );
          
          // ä¿å­˜èŠ‚ç‚¹çš„åŸå§‹çŠ¶æ€åˆ°ç¿»è¯‘å†å²
          if (!appState.translationHistory.find(h => h.nodeId === result.nodeId)) {
            appState.translationHistory.push({
              nodeId: result.nodeId,
              originalText: result.originalText,
              timestamp: new Date().toISOString()
            });
          }
        }
      },
      
      renderResults() {
        const container = document.getElementById('results-container');
        
        if (appState.results.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">ğŸ“„</div>
              <div class="empty-title">è¿˜æ²¡æœ‰ç¿»è¯‘ç»“æœ</div>
              <div class="empty-description">åˆ‡æ¢åˆ°é¦–é¡µå¼€å§‹ç¿»è¯‘</div>
            </div>
          `;
          return;
        }
        
        // æ·»åŠ å…¨å±€æ“ä½œæŒ‰é’®åŒºåŸŸ
        const hasResults = appState.results.length > 0;
        const hasSuccessResults = appState.results.some(r => r.status === 'success');
        
        let globalActionsHtml = '';
        if (hasSuccessResults) {
          globalActionsHtml = `
            <div class="results-global-actions">
              <h3>æ‰¹é‡æ“ä½œ</h3>
              <div class="global-actions-buttons">
                <button class="btn btn-warning" onclick="ui.undoAllTranslations()" title="æ’¤é”€æœ¬æ¬¡æ‰€æœ‰ç¿»è¯‘ï¼Œæ¢å¤åˆ°ç¿»è¯‘å‰çŠ¶æ€">
                  â†©ï¸ æ’¤é”€æœ¬æ¬¡ç¿»è¯‘
                </button>
                <button class="btn btn-secondary" onclick="ui.exportTranslationResults()" title="å¯¼å‡ºç¿»è¯‘ç»“æœåˆ°æ–‡ä»¶">
                  ğŸ“„ å¯¼å‡ºç»“æœ
                </button>
                <button class="btn btn-secondary" onclick="ui.clearResults()" title="æ¸…ç©ºç¿»è¯‘ç»“æœåˆ—è¡¨">
                  ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
                </button>
              </div>
            </div>
          `;
        }
        
        container.innerHTML = globalActionsHtml + (hasResults ? `
          <div class="results-list">
            <h3>ç¿»è¯‘ç»“æœ (${appState.results.length}é¡¹)</h3>
            ${appState.results.map((result, index) => `
          <div class="result-item ${result.status}">
            <div class="result-header">
              <span class="result-index">#${index + 1}</span>
              <span class="result-status ${result.status}">
                ${result.status === 'success' ? 'SUCCESS' : 'ERROR'}
              </span>
            </div>
            <div class="result-text">
              <div class="result-label">Original</div>
              <div class="result-content">${this.escapeHtml(result.originalText)}</div>
            </div>
            ${result.translatedText ? `
              <div class="result-text">
                <div class="result-label">Translation</div>
                <div class="result-content-editable" contenteditable="true" 
                     data-index="${index}" 
                     onblur="ui.updateTranslationResult(${index}, this.textContent.trim())"
                     onkeydown="ui.handleTranslationEdit(event, ${index})"
                     onfocus="ui.onTranslationEditFocus(event, ${index})"
                     title="Click to edit translation (Enter to save, Esc to cancel)">${this.escapeHtml(result.translatedText)}</div>
              </div>
            ` : ''}
            ${result.error ? `
              <div class="result-text">
                <div class="result-label">Error</div>
                <div class="result-content error">${this.escapeHtml(result.error)}</div>
              </div>
            ` : ''}
            <!-- å¼ºåˆ¶æ˜¾ç¤ºæ“ä½œæŒ‰é’® - ä¸ç®¡çŠ¶æ€å¦‚ä½• -->
            <div class="result-actions">
              ${result.status === 'success' ? `
                <span class="apply-status ${result.applied ? 'applied' : 'not-applied'}">
                  ${result.applied ? 'âœ… Auto-applied' : 'âš ï¸ Not applied'}
                </span>
                ${!result.applied ? `
                  <button class="btn btn-warning btn-small" onclick="ui.retryApplyTranslation(${index})" title="é‡è¯•åº”ç”¨ç¿»è¯‘">
                    ğŸ”„ Retry
                  </button>
                ` : ''}
              ` : ''}
              
              <button class="btn-icon btn-icon-copy" onclick="ui.copyTranslation(${index})" title="å¤åˆ¶ç¿»è¯‘ç»“æœ" aria-label="å¤åˆ¶ç¿»è¯‘ç»“æœ">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
              
              ${result.status === 'success' && result.originalText && result.translatedText ? `
                <button class="btn-icon btn-icon-glossary" onclick="ui.importToGlossary('${this.escapeHtml(result.originalText).replace(/'/g, "\\'")}', '${this.escapeHtml(result.translatedText).replace(/'/g, "\\'")})" title="å¯¼å…¥åˆ°è¯åº“" aria-label="å¯¼å…¥åˆ°è¯åº“">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 1.5 17V7A2.5 2.5 0 0 1 4 4.5h16A2.5 2.5 0 0 1 22.5 7v10a2.5 2.5 0 0 1-2.5 2.5z"></path>
                    <path d="M9 9h6"></path>
                    <path d="M9 15h6"></path>
                  </svg>
                </button>
              ` : ''}
              
              <!-- æ‰¹é‡ä¿®æ”¹ç›¸åŒæ–‡æœ¬æŒ‰é’® -->
              ${result.status === 'success' && result.originalText ? `
                <button class="btn-icon btn-icon-batch" onclick="ui.batchEditSameText('${this.escapeHtml(result.originalText).replace(/'/g, \"\\\\'\")}')" title="æ‰¹é‡ä¿®æ”¹æ‰€æœ‰ç›¸åŒåŸå§‹æ–‡æœ¬çš„ç¿»è¯‘" aria-label="æ‰¹é‡ä¿®æ”¹ç›¸åŒæ–‡æœ¬">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
              ` : ''}
              
              <!-- èŠ‚ç‚¹å®šä½æŒ‰é’® - å§‹ç»ˆæ˜¾ç¤ºï¼ˆå¦‚æœæœ‰ç»“æœï¼‰ -->
              <button class="btn-icon btn-icon-locate" onclick="ui.locateNode(${index})" title="åœ¨Figmaä¸­å®šä½æ­¤æ–‡æœ¬" aria-label="åœ¨Figmaä¸­å®šä½æ­¤æ–‡æœ¬">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M16.24 7.76L12 12 7.76 16.24"></path>
                  <path d="M12 8v8"></path>
                  <path d="M8 12h8"></path>
                </svg>
              </button>
            </div>
          </div>
        `).join('')}
          </div>
        ` : '');
      },
      
      // æ’¤é”€æœ¬æ¬¡æ‰€æœ‰ç¿»è¯‘
      undoAllTranslations() {
        if (!appState.translationHistory || appState.translationHistory.length === 0) {
          this.showNotification('æ²¡æœ‰å¯æ’¤é”€çš„ç¿»è¯‘å†å²', 'warning');
          return;
        }
        
        if (confirm('ç¡®å®šè¦æ’¤é”€æœ¬æ¬¡æ‰€æœ‰ç¿»è¯‘å—ï¼Ÿè¿™å°†æ¢å¤æ‰€æœ‰æ–‡æœ¬åˆ°ç¿»è¯‘å‰çš„çŠ¶æ€ã€‚')) {
          this.postMessage('undo-all-translations', {
            history: appState.translationHistory
          });
        }
      },
      
      // æ‰¹é‡ç¼–è¾‘ç›¸åŒåŸå§‹æ–‡æœ¬çš„ç¿»è¯‘
      batchEditSameText(originalText) {
        // æ‰¾åˆ°æ‰€æœ‰ç›¸åŒåŸå§‹æ–‡æœ¬çš„ç»“æœ
        const sameTextResults = appState.results.filter(r => 
          r.originalText === originalText && r.status === 'success'
        );
        
        if (sameTextResults.length === 0) {
          this.showNotification('æœªæ‰¾åˆ°ç›¸åŒçš„åŸå§‹æ–‡æœ¬', 'warning');
          return;
        }
        
        const currentTranslation = sameTextResults[0].translatedText || '';
        
        // å¼¹å‡ºç¼–è¾‘å¯¹è¯æ¡†
        const newTranslation = prompt(
          `æ‰¹é‡ä¿®æ”¹ç¿»è¯‘ï¼š\n\nåŸå§‹æ–‡æœ¬: ${originalText}\nå½“å‰ç¿»è¯‘: ${currentTranslation}\n\nè¯·è¾“å…¥æ–°çš„ç¿»è¯‘ (å…±${sameTextResults.length}ä¸ªç›¸åŒæ–‡æœ¬å°†è¢«ä¿®æ”¹):`,
          currentTranslation
        );
        
        if (newTranslation !== null && newTranslation.trim() !== '' && newTranslation !== currentTranslation) {
          this.batchUpdateTranslations(originalText, newTranslation.trim(), sameTextResults);
        }
      },
      
      // æ‰§è¡Œæ‰¹é‡æ›´æ–°ç¿»è¯‘
      batchUpdateTranslations(originalText, newTranslation, results) {
        // æ›´æ–°æœ¬åœ°ç»“æœ
        results.forEach(result => {
          const index = appState.results.findIndex(r => 
            r.nodeId === result.nodeId && r.originalText === originalText
          );
          if (index !== -1) {
            appState.results[index].translatedText = newTranslation;
          }
        });
        
        // å‘é€åˆ°ä¸»çº¿ç¨‹æ›´æ–°FigmaèŠ‚ç‚¹
        this.postMessage('batch-update-translations', {
          originalText,
          newTranslation,
          nodeIds: results.map(r => r.nodeId)
        });
        
        // é‡æ–°æ¸²æŸ“ç»“æœ
        this.renderResults();
        
        this.showNotification(`å·²æ‰¹é‡æ›´æ–° ${results.length} ä¸ªç›¸åŒæ–‡æœ¬çš„ç¿»è¯‘`, 'success');
      },
      
      // å¯¼å‡ºç¿»è¯‘ç»“æœ
      exportTranslationResults() {
        if (appState.results.length === 0) {
          this.showNotification('æ²¡æœ‰ç¿»è¯‘ç»“æœå¯å¯¼å‡º', 'warning');
          return;
        }
        
        const exportData = {
          timestamp: new Date().toISOString(),
          totalResults: appState.results.length,
          successCount: appState.results.filter(r => r.status === 'success').length,
          results: appState.results.map(r => ({
            originalText: r.originalText,
            translatedText: r.translatedText,
            status: r.status,
            applied: r.applied,
            error: r.error
          }))
        };
        
        const jsonString = JSON.stringify(exportData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `translation-results-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showNotification('ç¿»è¯‘ç»“æœå·²å¯¼å‡º', 'success');
      },
      
      // æ¸…ç©ºç»“æœ
      clearResults() {
        if (appState.results.length === 0) {
          this.showNotification('æ²¡æœ‰ç»“æœå¯æ¸…ç©º', 'warning');
          return;
        }
        
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¿»è¯‘ç»“æœå—ï¼Ÿæ­¤æ“ä½œä¸ä¼šå½±å“Figmaä¸­å·²åº”ç”¨çš„ç¿»è¯‘ã€‚')) {
          appState.results = [];
          appState.translationHistory = [];
          this.renderResults();
          this.showNotification('å·²æ¸…ç©ºæ‰€æœ‰ç¿»è¯‘ç»“æœ', 'success');
        }
      },
      
      // å¤„ç†æ’¤é”€ç»“æœ
      onUndoResult(payload) {
        if (payload.success) {
          // æ¸…ç©ºç¿»è¯‘ç»“æœå’Œå†å²
          appState.results = [];
          appState.translationHistory = [];
          this.renderResults();
          
          this.showNotification(payload.message || 'æ‰€æœ‰ç¿»è¯‘å·²æˆåŠŸæ’¤é”€', 'success');
          
          if (payload.errors && payload.errors.length > 0) {
            console.warn('æ’¤é”€è¿‡ç¨‹ä¸­çš„é”™è¯¯:', payload.errors);
          }
        } else {
          this.showNotification(`æ’¤é”€å¤±è´¥: ${payload.error}`, 'error');
        }
      },
      
      // å¤„ç†æ‰¹é‡æ›´æ–°ç»“æœ
      onBatchUpdateResult(payload) {
        if (payload.success) {
          this.showNotification(payload.message || 'æ‰¹é‡æ›´æ–°å®Œæˆ', 'success');
          
          if (payload.errors && payload.errors.length > 0) {
            console.warn('æ‰¹é‡æ›´æ–°è¿‡ç¨‹ä¸­çš„é”™è¯¯:', payload.errors);
          }
        } else {
          this.showNotification(`æ‰¹é‡æ›´æ–°å¤±è´¥: ${payload.error}`, 'error');
        }
      },
      
      copyTranslation(index) {
        const result = appState.results[index];
        if (result && result.translatedText) {
          // å°è¯•ç°ä»£ clipboard API
          if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(result.translatedText).then(() => {
              this.showNotification('Translation copied to clipboard', 'success');
            }).catch(() => {
              this.fallbackCopyText(result.translatedText);
            });
          } else {
            // å›é€€åˆ°ä¼ ç»Ÿæ–¹æ³•
            this.fallbackCopyText(result.translatedText);
          }
        } else {
          this.showNotification('No translation text to copy', 'error');
        }
      },
      
      // å…¼å®¹æ€§å¤åˆ¶æ–¹æ³•
      fallbackCopyText(text) {
        try {
          // åˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          // æ‰§è¡Œå¤åˆ¶å‘½ä»¤
          const successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          
          if (successful) {
            this.showNotification('Translation copied to clipboard', 'success');
          } else {
            this.showNotification('Copy failed - please select and copy manually', 'error');
          }
        } catch (err) {
          console.error('Copy failed:', err);
          this.showNotification('Copy failed - please select and copy manually', 'error');
        }
      },
      
      async retryApplyTranslation(index) {
        const result = appState.results[index];
        if (!result || !result.translatedText) {
          this.showNotification('No translation to apply', 'error');
          return;
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const retryBtn = document.querySelector(`button[onclick="ui.retryApplyTranslation(${index})"]`);
        if (retryBtn) {
          retryBtn.disabled = true;
          retryBtn.innerHTML = 'ğŸ”„ Retrying...';
        }
        
        try {
          // è·å–å½“å‰ç¿»è¯‘æ¨¡å¼
          const mode = document.getElementById('mode').value || 'replace';
          
          // å‘é€é‡è¯•è¯·æ±‚
          const response = await this.sendMessage({
            type: 'apply-translation',
            payload: {
              nodeId: result.nodeId,
              translatedText: result.translatedText,
              mode: mode
            }
          });
          
          if (response && response.payload && response.payload.success) {
            // æ›´æ–°ç»“æœçŠ¶æ€
            appState.results[index].applied = true;
            this.renderResults();
            this.showNotification('Translation applied successfully!', 'success');
          } else {
            const errorMsg = (response && response.payload && response.payload.error) || 'Failed to apply translation';
            this.showNotification(`Retry failed: ${errorMsg}`, 'error');
          }
        } catch (error) {
          console.error('Retry apply translation error:', error);
          this.showNotification('Retry failed: ' + error.message, 'error');
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          if (retryBtn) {
            retryBtn.disabled = false;
            retryBtn.innerHTML = 'ğŸ”„ Retry';
          }
        }
      },
      
      // UI updates
      updateUI() {
        // Update selection stats
        document.getElementById('total-nodes').textContent = appState.selection.totalNodes;
        document.getElementById('text-nodes').textContent = appState.selection.textNodes;
        
        // Update translate button
        const translateBtn = document.getElementById('translate-btn');
        const hasSelection = appState.selection.textNodes > 0;
        const hasEngine = document.getElementById('engine').value !== '';
        const hasModel = document.getElementById('model-select').value !== '';
        const hasApiKey = document.getElementById('api-key').value.trim() !== '';
        
        const canTranslate = hasSelection && hasEngine && hasModel && hasApiKey;
        translateBtn.disabled = !canTranslate || appState.isTranslating;
        translateBtn.textContent = appState.isTranslating ? 'ğŸ”„ Translating...' : 'ğŸš€ Translate';
        
        // Update connection status
        const statusEl = document.getElementById('connection-status');
        if (appState.connected) {
          statusEl.textContent = 'connected';
          statusEl.className = 'connection-status connected';
        } else {
          statusEl.textContent = 'disconnected';
          statusEl.className = 'connection-status disconnected';
        }
      },
      
      // Notifications
      showNotification(message, type) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} active`;
        
        setTimeout(() => {
          notification.classList.remove('active');
        }, 3000);
      },
      
      // Message handling
      postMessage(type, payload) {
        const message = { type: type, payload: payload || {} };
        console.log('Sending message:', message);
        parent.postMessage({ pluginMessage: message }, '*');
      },
      
      handleMessage(message) {
        console.log('Received message:', message.type, message);
        
        switch (message.type) {
          case 'plugin-ready':
            appState.connected = true;
            this.updateUI();
            this.showNotification('Plugin connected', 'success');
            // Load settings from storage
            this.postMessage('load-settings');
            setTimeout(() => this.refreshSelection(), 100);
            break;
            
          case 'selection-info':
            appState.selection = {
              totalNodes: message.payload.totalNodes || 0,
              textNodes: message.payload.textNodes || 0,
              nodeIds: message.payload.nodeIds || []
            };
            this.updateUI();
            break;
            
          case 'translation-progress':
            this.updateProgress(message.payload.progress, message.payload.status);
            break;
            
          case 'translation-result':
            this.addResult(message.payload);
            break;
            
          case 'translation-complete':
            appState.isTranslating = false;
            this.updateUI();
            this.updateProgress(100, 'Complete');
            document.getElementById('progress-section').classList.remove('active');
            this.showNotification(
              `Translation complete! ${message.payload.successCount} success, ${message.payload.failureCount} failed`,
              'success'
            );
            break;
            
          case 'undo-result':
            this.onUndoResult(message.payload);
            break;
            
          case 'batch-update-result':
            this.onBatchUpdateResult(message.payload);
            break;
            
          case 'engine-test-result':
            const engine = message.payload.engine;
            const testBtn = document.getElementById(engine + '-test-btn');
            testBtn.disabled = false;
            
            if (message.payload.success) {
              testBtn.textContent = 'Test Connection';
              this.showNotification(`${engine} connection test passed`, 'success');
            } else {
              testBtn.textContent = 'Test Failed';
              this.showNotification(`${engine} test failed: ${message.payload.error}`, 'error');
              setTimeout(() => {
                testBtn.textContent = 'Test Connection';
              }, 2000);
            }
            break;
            
          case 'settings-loaded':
            console.log('Settings loaded:', message.payload);
            // Apply loaded settings to the UI state
            if (message.payload.engines) {
              appState.engines = message.payload.engines;
            }
            if (message.payload.settings) {
              appState.settings = message.payload.settings;
              document.getElementById('target-lang').value = appState.settings.defaultTargetLang;
            }
            if (message.payload.translationMemories) {
              appState.translationMemories = message.payload.translationMemories;
            }
            if (message.payload.glossary) {
              appState.glossary = message.payload.glossary;
            }
            if (message.payload.advancedPrompt) {
              appState.advancedPrompt = message.payload.advancedPrompt;
            }
            if (message.payload.contentFilters) {
              appState.contentFilters = message.payload.contentFilters;
            }
            if (message.payload.general) {
              appState.general = message.payload.general;
            }
            this.updateEngineDropdown();
            this.updateUI();
            break;
            
          case 'settings-save-result':
            if (message.payload.success) {
              console.log('Settings persisted to storage successfully');
            } else {
              this.showNotification('Failed to save settings: ' + message.payload.error, 'error');
            }
            break;
            
          case 'locate-result':
            if (message.payload.success) {
              this.showNotification('èŠ‚ç‚¹å®šä½æˆåŠŸï¼', 'success');
            } else {
              this.showNotification(`å®šä½å¤±è´¥: ${message.payload.error}`, 'error');
            }
            break;
            
          case 'error':
            this.showNotification(message.payload.error, 'error');
            if (appState.isTranslating) {
              appState.isTranslating = false;
              this.updateUI();
              document.getElementById('progress-section').classList.remove('active');
            }
            break;
            
          default:
            console.log('Unknown message type:', message.type);
        }
      },
      
      // èŠ‚ç‚¹å®šä½åŠŸèƒ½
      locateNode(index) {
        const result = appState.results[index];
        if (result && result.nodeId) {
          this.postMessage('locate-node', { nodeId: result.nodeId });
          this.showNotification('æ­£åœ¨å®šä½åˆ°è¯¥èŠ‚ç‚¹...', 'success');
        } else {
          this.showNotification('æ— æ³•å®šä½èŠ‚ç‚¹ï¼šèŠ‚ç‚¹IDç¼ºå¤±', 'error');
        }
      },
      
      // è¯åº“ç®¡ç†åŠŸèƒ½
      addGlossaryTerm() {
        const sourceText = document.getElementById('glossary-source').value.trim();
        const targetText = document.getElementById('glossary-target').value.trim();
        
        if (!sourceText || !targetText) {
          this.showNotification('è¯·è¾“å…¥æºæ–‡æœ¬å’Œç›®æ ‡æ–‡æœ¬', 'error');
          return;
        }
        
        // å¢å¼ºçš„å»é‡æ£€æŸ¥ï¼šæ£€æŸ¥æºæ–‡æœ¬çš„ç²¾ç¡®åŒ¹é…å’Œæ¨¡ç³ŠåŒ¹é…
        const existingIndex = appState.glossary.terms.findIndex(term => 
          term.source.toLowerCase().trim() === sourceText.toLowerCase().trim()
        );
        
        if (existingIndex >= 0) {
          const existingTerm = appState.glossary.terms[existingIndex];
          if (existingTerm.target === targetText) {
            this.showNotification('è¯¥è¯åº“æ¡ç›®å·²å­˜åœ¨', 'warning');
            return;
          }
          
          // å¦‚æœç›®æ ‡æ–‡æœ¬ä¸åŒï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦æ›´æ–°
          if (confirm(`è¯åº“ä¸­å·²å­˜åœ¨ "${sourceText}"ï¼Œå½“å‰ç¿»è¯‘ä¸º "${existingTerm.target}"ã€‚\næ˜¯å¦æ›´æ–°ä¸º "${targetText}"ï¼Ÿ`)) {
            appState.glossary.terms[existingIndex] = {
              ...existingTerm,
              target: targetText,
              updatedAt: Date.now()
            };
            this.showNotification('è¯åº“æ¡ç›®å·²æ›´æ–°', 'success');
          } else {
            return;
          }
        } else {
          // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸ä¼¼çš„æºæ–‡æœ¬ï¼ˆé˜²æ­¢é‡å¤æ·»åŠ ç›¸ä¼¼æ¡ç›®ï¼‰
          const similarTerm = appState.glossary.terms.find(term => {
            const similarity = this.calculateTextSimilarity(term.source, sourceText);
            return similarity > 0.8; // 80%ç›¸ä¼¼åº¦
          });
          
          if (similarTerm) {
            if (!confirm(`è¯åº“ä¸­å­˜åœ¨ç›¸ä¼¼æ¡ç›®ï¼š"${similarTerm.source}" â†’ "${similarTerm.target}"ã€‚\næ˜¯å¦ä»è¦æ·»åŠ æ–°æ¡ç›®ï¼Ÿ`)) {
              return;
            }
          }
          
          // æ·»åŠ æ–°è¯æ¡
          appState.glossary.terms.push({
            id: Date.now().toString(),
            source: sourceText,
            target: targetText,
            createdAt: Date.now()
          });
          this.showNotification('å·²æ·»åŠ åˆ°è¯åº“', 'success');
        }
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('glossary-source').value = '';
        document.getElementById('glossary-target').value = '';
        
        // åˆ·æ–°è¯åº“æ˜¾ç¤º
        this.renderGlossaryTerms();
        
        // ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°çŠ¶æ€å’ŒFigmaå­˜å‚¨ï¼Œä½†ä¸å…³é—­è®¾ç½®é¡µé¢
        this.saveSettingsData();
      },
      
      removeGlossaryTerm(index) {
        if (index >= 0 && index < appState.glossary.terms.length) {
          appState.glossary.terms.splice(index, 1);
          this.renderGlossaryTerms();
          this.saveSettingsData();
          this.showNotification('å·²åˆ é™¤è¯åº“æ¡ç›®', 'success');
        }
      },
      
      clearGlossary() {
        if (appState.glossary.terms.length === 0) {
          this.showNotification('è¯åº“å·²ä¸ºç©º', 'warning');
          return;
        }
        
        if (confirm(`ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${appState.glossary.terms.length}ä¸ªè¯åº“æ¡ç›®å—ï¼Ÿ`)) {
          appState.glossary.terms = [];
          this.renderGlossaryTerms();
          this.saveSettingsData();
          this.showNotification('è¯åº“å·²æ¸…ç©º', 'success');
        }
      },
      
      renderGlossaryTerms() {
        const container = document.getElementById('glossary-terms');
        if (!container) return;
        
        if (appState.glossary.terms.length === 0) {
          container.innerHTML = '<div class="empty-state">æš‚æ— è¯åº“æ¡ç›®</div>';
          return;
        }
        
        const termsHtml = appState.glossary.terms.map((term, index) => `
          <div class="glossary-term-item" data-index="${index}">
            <div class="term-content">
              <div class="term-source" contenteditable="true" 
                   onblur="ui.updateGlossaryTerm(${index}, 'source', this.textContent.trim())"
                   onkeydown="ui.handleGlossaryEdit(event, ${index}, 'source')">${this.escapeHtml(term.source)}</div>
              <div class="term-arrow">â†’</div>
              <div class="term-target" contenteditable="true"
                   onblur="ui.updateGlossaryTerm(${index}, 'target', this.textContent.trim())"
                   onkeydown="ui.handleGlossaryEdit(event, ${index}, 'target')">${this.escapeHtml(term.target)}</div>
            </div>
            <div class="term-actions">
              <button class="btn-icon btn-icon-edit" onclick="ui.editGlossaryTerm(${index})" title="ç¼–è¾‘" aria-label="ç¼–è¾‘">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="btn-icon btn-icon-delete" onclick="ui.removeGlossaryTerm(${index})" title="åˆ é™¤" aria-label="åˆ é™¤">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3,6 5,6 21,6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </div>
        `).join('');
        
        container.innerHTML = termsHtml;
      },
      
      // ä»ç¿»è¯‘ç»“æœå¯¼å…¥è¯åº“æ¡ç›®
      importToGlossary(sourceText, targetText) {
        if (!sourceText || !targetText) return;
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const exists = appState.glossary.terms.some(term => 
          term.source.toLowerCase() === sourceText.toLowerCase()
        );
        
        if (!exists) {
          appState.glossary.terms.push({
            source: sourceText,
            target: targetText,
            createdAt: Date.now()
          });
          this.saveSettingsData();
          this.showNotification('å·²å¯¼å…¥åˆ°è¯åº“', 'success');
        } else {
          this.showNotification('è¯¥è¯æ¡å·²å­˜åœ¨äºè¯åº“ä¸­', 'warning');
        }
      },
      
      // è¯åº“åŒ¹é…åŠŸèƒ½
      findGlossaryMatch(text) {
        if (!appState.glossary.enabled || appState.glossary.terms.length === 0) {
          return null;
        }
        
        const sensitivity = appState.glossary.sensitivity;
        
        for (const term of appState.glossary.terms) {
          if (sensitivity === 'exact') {
            if (term.source === text) {
              return term.target;
            }
          } else if (sensitivity === 'fuzzy') {
            if (term.source.toLowerCase() === text.toLowerCase()) {
              return term.target;
            }
          } else if (sensitivity === 'partial') {
            if (text.toLowerCase().includes(term.source.toLowerCase()) || 
                term.source.toLowerCase().includes(text.toLowerCase())) {
              return term.target;
            }
          }
        }
        
        return null;
      },
      
      // ç¿»è¯‘ç»“æœç¼–è¾‘åŠŸèƒ½
      updateTranslationResult(index, newText) {
        console.log(`æ›´æ–°ç¿»è¯‘ç»“æœ: ç´¢å¼•=${index}, æ–°æ–‡æœ¬="${newText}"`);
        
        // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
        const editableElements = document.querySelectorAll(`.result-content-editable[data-index="${index}"]`);
        editableElements.forEach(el => el.classList.remove('editing'));
        
        if (index >= 0 && index < appState.results.length) {
          const result = appState.results[index];
          const oldText = result.translatedText;
          
          if (newText !== oldText) {
            // æ›´æ–°æœ¬åœ°çŠ¶æ€
            result.translatedText = newText;
            
            console.log(`ç¿»è¯‘ç»“æœå·²æ›´æ–°: "${oldText}" -> "${newText}"`);
            this.showNotification('ç¿»è¯‘ç»“æœå·²æ›´æ–°', 'success');
            
            // å¦‚æœç»“æœå·²åº”ç”¨åˆ°Figmaï¼Œé‡æ–°åº”ç”¨æ–°çš„ç¿»è¯‘
            if (result.applied && result.nodeId) {
              console.log(`é‡æ–°åº”ç”¨ç¿»è¯‘åˆ°èŠ‚ç‚¹: ${result.nodeId}`);
              this.postMessage('apply-translation', {
                nodeId: result.nodeId,
                translatedText: newText,
                mode: appState.selectedOutputMode || 'replace'
              });
            }
            
            // å°†ç¼–è¾‘åçš„ç¿»è¯‘æ·»åŠ åˆ°è¯åº“ï¼ˆå¦‚æœå¯ç”¨äº†è‡ªåŠ¨ä¿å­˜ï¼‰
            const autoSaveGlossary = document.getElementById('auto-save-glossary') && document.getElementById('auto-save-glossary').checked;
            if (autoSaveGlossary && result.originalText && newText.trim()) {
              this.addToGlossaryFromEdit(result.originalText, newText);
            }
          } else {
            console.log('ç¿»è¯‘å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°');
          }
        } else {
          console.error(`æ— æ•ˆçš„ç´¢å¼•: ${index}, ç»“æœæ•°ç»„é•¿åº¦: ${appState.results.length}`);
        }
      },
      
      handleTranslationEdit(event, index) {
        const element = event.target;
        
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          element.blur(); // è§¦å‘ onblur äº‹ä»¶æ¥ä¿å­˜
        }
        if (event.key === 'Escape') {
          event.preventDefault();
          // æ¢å¤åŸå†…å®¹
          const originalText = element.dataset.originalText || (appState.results[index] && appState.results[index].translatedText) || '';
          element.textContent = originalText;
          element.classList.remove('editing');
          element.blur();
        }
      },
      
      // ä»ç¼–è¾‘æ“ä½œæ·»åŠ åˆ°è¯åº“
      addToGlossaryFromEdit(originalText, translatedText) {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const exists = appState.glossary.terms.some(term => 
          term.source.toLowerCase() === originalText.toLowerCase()
        );
        
        if (!exists) {
          appState.glossary.terms.push({
            source: originalText,
            target: translatedText,
            createdAt: Date.now(),
            fromEdit: true
          });
          
          console.log(`ä»ç¼–è¾‘æ·»åŠ åˆ°è¯åº“: "${originalText}" -> "${translatedText}"`);
          this.showNotification(`å·²æ·»åŠ åˆ°è¯åº“: ${originalText} â†’ ${translatedText}`, 'info');
        }
      },
      
      // ç¿»è¯‘ç¼–è¾‘èšç„¦å¤„ç†
      onTranslationEditFocus(event, index) {
        const element = event.target;
        element.dataset.originalText = element.textContent; // å­˜å‚¨åŸå§‹æ–‡æœ¬ç”¨äºå–æ¶ˆ
        element.classList.add('editing');
        
        // é€‰æ‹©æ‰€æœ‰æ–‡æœ¬ä»¥ä¾¿ç”¨æˆ·ç›´æ¥è¾“å…¥
        setTimeout(() => {
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(element);
          selection.removeAllRanges();
          selection.addRange(range);
        }, 0);
      },
      
      // æ–‡æœ¬ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆç®€å•çš„ç¼–è¾‘è·ç¦»ç®—æ³•ï¼‰
      calculateTextSimilarity(str1, str2) {
        if (!str1 || !str2) return 0;
        
        const s1 = str1.toLowerCase().trim();
        const s2 = str2.toLowerCase().trim();
        
        if (s1 === s2) return 1;
        
        const longer = s1.length > s2.length ? s1 : s2;
        const shorter = s1.length > s2.length ? s2 : s1;
        
        if (longer.length === 0) return 1;
        
        const editDistance = this.levenshteinDistance(longer, shorter);
        return (longer.length - editDistance) / longer.length;
      },
      
      // è®¡ç®—ç¼–è¾‘è·ç¦»
      levenshteinDistance(str1, str2) {
        const matrix = [];
        
        for (let i = 0; i <= str2.length; i++) {
          matrix[i] = [i];
        }
        
        for (let j = 0; j <= str1.length; j++) {
          matrix[0][j] = j;
        }
        
        for (let i = 1; i <= str2.length; i++) {
          for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
              matrix[i][j] = matrix[i - 1][j - 1];
            } else {
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1,
                matrix[i][j - 1] + 1,
                matrix[i - 1][j] + 1
              );
            }
          }
        }
        
        return matrix[str2.length][str1.length];
      },
      
      // è¯åº“ç¼–è¾‘åŠŸèƒ½
      updateGlossaryTerm(index, field, newValue) {
        if (index >= 0 && index < appState.glossary.terms.length && newValue) {
          const term = appState.glossary.terms[index];
          if (term[field] !== newValue) {
            // å¦‚æœä¿®æ”¹æºæ–‡æœ¬ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å†²çª
            if (field === 'source') {
              const conflictIndex = appState.glossary.terms.findIndex((t, i) => 
                i !== index && t.source.toLowerCase().trim() === newValue.toLowerCase().trim()
              );
              
              if (conflictIndex >= 0) {
                this.showNotification('è¯¥æºæ–‡æœ¬å·²å­˜åœ¨äºè¯åº“ä¸­', 'error');
                // æ¢å¤åŸå§‹å€¼
                document.querySelector(`[data-index="${index}"] .term-${field}`).textContent = term[field];
                return;
              }
            }
            
            term[field] = newValue;
            term.updatedAt = Date.now();
            this.showNotification('è¯åº“æ¡ç›®å·²æ›´æ–°', 'success');
            this.saveSettingsData();
          }
        }
      },
      
      handleGlossaryEdit(event, index, field) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          event.target.blur();
        }
        if (event.key === 'Escape') {
          event.preventDefault();
          // æ¢å¤åŸå§‹å€¼
          event.target.textContent = appState.glossary.terms[index][field];
          event.target.blur();
        }
      },
      
      editGlossaryTerm(index) {
        // é«˜äº®æ˜¾ç¤ºè¯¥æ¡ç›®è¿›å…¥ç¼–è¾‘çŠ¶æ€
        const termItem = document.querySelector(`[data-index="${index}"]`);
        if (termItem) {
          termItem.style.background = '#fff3cd';
          termItem.style.borderColor = '#ffeaa7';
          
          setTimeout(() => {
            termItem.style.background = '';
            termItem.style.borderColor = '';
          }, 2000);
          
          // èšç„¦åˆ°æºæ–‡æœ¬ç¼–è¾‘
          const sourceElement = termItem.querySelector('.term-source');
          if (sourceElement) {
            sourceElement.focus();
          }
        }
      },
      
      // æ–°çš„è®¾ç½®é¡µé¢åŠŸèƒ½å®ç°
      
      // åŠ è½½åŸºç¡€Prompt
      loadBasePrompt() {
        const basePromptDisplay = document.getElementById('base-prompt-display');
        if (basePromptDisplay) {
          basePromptDisplay.textContent = `You are a professional translator specializing in networking and smart home device interfaces. You translate UI elements for TP-Link products including routers, switches, access points, smart plugs, cameras, and IoT devices.

CRITICAL TRANSLATION RULES:
1. NEVER add quotes, brackets, or any extra formatting around the translation
2. Output ONLY the translated text, nothing else
3. Maintain exact formatting, capitalization patterns, and punctuation
4. Preserve technical terms, model numbers, and brand names
5. Keep all symbols, special characters, and spacing identical
6. Translate UI labels using standard industry terminology
7. For networking terms, use established Chinese technical vocabulary
8. For smart home features, use commonly accepted Chinese terms`;
        }
      },
      
      // åŠ è½½Promptè®¾ç½®
      loadPromptSettings() {
        const projectType = document.getElementById('project-type');
        const industry = document.getElementById('project-industry');
        const targetAudience = document.getElementById('target-audience');
        const languageStyle = document.getElementById('language-style');
        const specialInstructions = document.getElementById('special-instructions');
        
        if (projectType) projectType.value = appState.advancedPrompt.projectType;
        if (industry) industry.value = appState.advancedPrompt.industry;
        if (targetAudience) targetAudience.value = appState.advancedPrompt.targetAudience;
        if (languageStyle) languageStyle.value = appState.advancedPrompt.languageStyle;
        if (specialInstructions) specialInstructions.value = appState.advancedPrompt.specialInstructions;
        
        this.renderConstraints();
      },
      
      // æ¸²æŸ“çº¦æŸåˆ—è¡¨
      renderConstraints() {
        const container = document.getElementById('constraints-list');
        if (!container) return;
        
        if (appState.advancedPrompt.constraints.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ”’</div><div class="empty-title">No constraints defined</div><div class="empty-description">Add constraints to ensure consistent translation of specific terms</div></div>';
          return;
        }
        
        const constraintsHtml = appState.advancedPrompt.constraints.map((constraint, index) => `
          <div class="constraint-item">
            <div class="constraint-content">
              <div class="constraint-source">${this.escapeHtml(constraint.source)}</div>
              <div class="constraint-arrow">â†’</div>
              <div class="constraint-target">${this.escapeHtml(constraint.target)}</div>
              <div class="constraint-type">(${constraint.type})</div>
            </div>
            <button class="btn-icon btn-icon-delete" onclick="ui.removeConstraint(${index})" title="åˆ é™¤">ğŸ—‘ï¸</button>
          </div>
        `).join('');
        
        container.innerHTML = constraintsHtml;
      },
      
      // æ·»åŠ çº¦æŸï¼ˆå¢å¼ºç‰ˆï¼‰
      addConstraint() {
        // åˆ›å»ºæ¨¡æ€æ¡†å½¢å¼çš„çº¦æŸæ·»åŠ ç•Œé¢
        const modalHtml = `
          <div class="constraint-modal-overlay" id="constraint-modal">
            <div class="constraint-modal">
              <div class="constraint-modal-header">
                <h3>Add Translation Constraint</h3>
                <button onclick="ui.closeConstraintModal()" class="modal-close">Ã—</button>
              </div>
              <div class="constraint-modal-body">
                <div class="form-group">
                  <label class="form-label">Source Text</label>
                  <input type="text" class="input" id="constraint-source" placeholder="e.g., TP-Link">
                </div>
                <div class="form-group">
                  <label class="form-label">Fixed Translation</label>
                  <input type="text" class="input" id="constraint-target" placeholder="e.g., TP-Link">
                </div>
                <div class="form-row">
                  <div class="form-col">
                    <label class="form-label">Constraint Type</label>
                    <select class="select" id="constraint-type">
                      <option value="exact">Exact Match</option>
                      <option value="pattern">Regex Pattern</option>
                      <option value="context">Context-aware</option>
                    </select>
                  </div>
                  <div class="form-col">
                    <label class="form-label">Priority</label>
                    <select class="select" id="constraint-priority">
                      <option value="absolute">Absolute</option>
                      <option value="high" selected>High</option>
                      <option value="medium">Medium</option>
                      <option value="low">Low</option>
                    </select>
                  </div>
                </div>
                <div id="constraint-conflicts" class="constraint-conflicts"></div>
              </div>
              <div class="constraint-modal-footer">
                <button class="btn btn-secondary" onclick="ui.closeConstraintModal()">Cancel</button>
                <button class="btn btn-primary" onclick="ui.saveConstraint()">Add Constraint</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // å®æ—¶å†²çªæ£€æµ‹
        document.getElementById('constraint-source').addEventListener('input', () => {
          this.checkConstraintConflicts();
        });
        document.getElementById('constraint-target').addEventListener('input', () => {
          this.checkConstraintConflicts();
        });
      },
      
      // å…³é—­çº¦æŸæ¨¡æ€æ¡†
      closeConstraintModal() {
        const modal = document.getElementById('constraint-modal');
        if (modal) {
          modal.remove();
        }
      },
      
      // ä¿å­˜çº¦æŸ
      saveConstraint() {
        const source = document.getElementById('constraint-source').value.trim();
        const target = document.getElementById('constraint-target').value.trim();
        const type = document.getElementById('constraint-type').value;
        const priority = document.getElementById('constraint-priority').value;
        
        if (!source || !target) {
          this.showNotification('è¯·è¾“å…¥æºæ–‡æœ¬å’Œç›®æ ‡æ–‡æœ¬', 'error');
          return;
        }
        
        // æ£€æŸ¥å†²çª
        const existingIndex = appState.advancedPrompt.constraints.findIndex(
          c => c.source.toLowerCase() === source.toLowerCase()
        );
        
        if (existingIndex >= 0 && appState.advancedPrompt.constraints[existingIndex].target !== target) {
          if (!confirm(`æºæ–‡æœ¬ "${source}" å·²å­˜åœ¨çº¦æŸã€‚æ˜¯å¦æ›¿æ¢ï¼Ÿ`)) {
            return;
          }
          appState.advancedPrompt.constraints[existingIndex] = {
            source,
            target,
            type,
            priority,
            updatedAt: Date.now()
          };
        } else {
          appState.advancedPrompt.constraints.push({
            id: Date.now().toString(),
            source,
            target,
            type,
            priority,
            createdAt: Date.now()
          });
        }
        
        this.closeConstraintModal();
        this.renderConstraints();
        this.showNotification('çº¦æŸå·²æ·»åŠ ', 'success');
      },
      
      // æ£€æŸ¥çº¦æŸå†²çª
      checkConstraintConflicts() {
        const source = document.getElementById('constraint-source') && document.getElementById('constraint-source').value.trim();
        const conflictsDiv = document.getElementById('constraint-conflicts');
        
        if (!source || !conflictsDiv) return;
        
        const existingConstraint = appState.advancedPrompt.constraints.find(
          c => c.source.toLowerCase() === source.toLowerCase()
        );
        
        if (existingConstraint) {
          conflictsDiv.innerHTML = `
            <div class="constraint-warning">
              âš ï¸ çº¦æŸå†²çªï¼šæºæ–‡æœ¬ "${source}" å·²å­˜åœ¨ï¼Œå½“å‰ç¿»è¯‘ä¸º "${existingConstraint.target}"
            </div>
          `;
        } else {
          conflictsDiv.innerHTML = '';
        }
      },
      
      // åˆ é™¤çº¦æŸ
      removeConstraint(index) {
        if (index >= 0 && index < appState.advancedPrompt.constraints.length) {
          appState.advancedPrompt.constraints.splice(index, 1);
          this.renderConstraints();
          this.showNotification('çº¦æŸå·²åˆ é™¤', 'success');
        }
      },
      
      // å¯¼å…¥çº¦æŸ
      importConstraints() {
        this.showNotification('çº¦æŸå¯¼å…¥åŠŸèƒ½å¼€å‘ä¸­...', 'info');
      },
      
      // é¢„è§ˆPrompt
      previewPrompt() {
        const testText = document.getElementById('preview-text').value.trim();
        if (!testText) {
          this.showNotification('è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬', 'warning');
          return;
        }
        
        // ç”Ÿæˆå®Œæ•´çš„promptï¼ˆä½¿ç”¨å½“å‰UIè®¾ç½®ï¼‰
        const sourceLang = (document.getElementById('source-lang') && document.getElementById('source-lang').value) || 'auto';
        const targetLang = (document.getElementById('target-lang') && document.getElementById('target-lang').value) || 'zh-CN';
        const fullPrompt = this.generateFullPrompt(testText, sourceLang, targetLang);
        const previewDisplay = document.getElementById('prompt-preview-display');
        if (previewDisplay) {
          previewDisplay.textContent = fullPrompt;
        }
      },
      
      // ç”Ÿæˆå®Œæ•´Promptï¼ˆç”¨äºå®é™…ç¿»è¯‘ï¼‰
      generateFullPrompt(text, sourceLang = 'auto', targetLang = 'zh-CN') {
        const basePrompt = this.getBasePrompt();
        const context = this.buildProjectContext();
        const constraints = this.buildConstraintsPrompt();
        const glossaryPrompt = this.buildGlossaryPrompt();
        
        return `${basePrompt}

TRANSLATION REQUEST:
- From: ${sourceLang === 'auto' ? 'Auto-detect' : sourceLang}
- To: ${targetLang}

${context}

${constraints}

${glossaryPrompt}

CRITICAL INSTRUCTIONS:
1. Apply fixed translation constraints FIRST (highest priority)
2. Use glossary terms when available (medium priority) 
3. Follow project context and style guidelines (low priority)
4. Maintain all original formatting exactly

Text to translate: "${text}"

Translation:`;
      },
      
      // è·å–å®Œæ•´çš„åŸºç¡€Prompt
      getBasePrompt() {
        return `You are a professional translator specializing in networking and smart home device interfaces. You translate UI elements for TP-Link products including routers, switches, access points, smart plugs, cameras, and IoT devices.

CORE TRANSLATION PRINCIPLES:
1. NEVER add quotes, brackets, or any extra formatting around the translation
2. Output ONLY the translated text, nothing else
3. Maintain exact formatting, capitalization patterns, and punctuation
4. Preserve technical terms, model numbers, and brand names
5. Keep all symbols, special characters, and spacing identical
6. Translate UI labels using standard industry terminology
7. For networking terms, use established technical vocabulary
8. For smart home features, use commonly accepted terms

BRAND PROTECTION:
- Keep "TP-Link", "Archer", "Deco", "Tapo" in English
- Preserve model numbers (e.g., "AC1900", "AX6000")
- Keep version numbers unchanged (e.g., "v1.2.3")

TECHNICAL TERMINOLOGY:
- Router â†’ è·¯ç”±å™¨
- Switch â†’ äº¤æ¢æœº
- Access Point â†’ æ¥å…¥ç‚¹
- WiFi â†’ WiFi (keep as-is)
- Ethernet â†’ ä»¥å¤ªç½‘
- Bandwidth â†’ å¸¦å®½
- Firewall â†’ é˜²ç«å¢™
- Smart Plug â†’ æ™ºèƒ½æ’åº§
- Smart Camera â†’ æ™ºèƒ½æ‘„åƒå¤´`;
      },
      
      // æ„å»ºè¯åº“Prompt
      buildGlossaryPrompt() {
        if (!appState.glossary.enabled || appState.glossary.terms.length === 0) {
          return '';
        }
        
        let glossaryPrompt = 'GLOSSARY TERMS (Use these translations when applicable):\n';
        appState.glossary.terms.forEach(term => {
          glossaryPrompt += `- "${term.source}" â†’ "${term.target}"\n`;
        });
        
        return glossaryPrompt;
      },
      
      // çº¦æŸç¿»è¯‘å¤„ç†å™¨
      processTranslationWithConstraints(text, sourceLang = 'auto', targetLang = 'zh-CN') {
        // ç¬¬ä¸€é˜¶æ®µï¼šé¢„å¤„ç†æ–‡æœ¬ï¼Œåº”ç”¨çº¦æŸ
        const processResult = this.preProcessWithConstraints(text);
        
        // ç¬¬äºŒé˜¶æ®µï¼šç”Ÿæˆç”¨äºAIçš„å¤„ç†åprompt
        const enhancedPrompt = this.generateFullPrompt(processResult.processedText, sourceLang, targetLang);
        
        // ç¬¬ä¸‰é˜¶æ®µï¼šåå¤„ç†å‡½æ•°ï¼ˆåœ¨AIç¿»è¯‘åä½¿ç”¨ï¼‰
        return {
          enhancedPrompt,
          postProcess: (aiTranslation) => this.postProcessWithConstraints(aiTranslation, processResult.segments)
        };
      },
      
      // é¢„å¤„ç†ï¼šåº”ç”¨çº¦æŸå‰çš„æ–‡æœ¬åˆ†æ
      preProcessWithConstraints(text) {
        const segments = [];
        let processedText = text;
        
        // æŒ‰ä¼˜å…ˆçº§æ’åºçº¦æŸ
        const sortedConstraints = [...appState.advancedPrompt.constraints].sort((a, b) => {
          const priorityWeights = { 'absolute': 1, 'high': 2, 'medium': 3, 'low': 4 };
          return priorityWeights[a.priority] - priorityWeights[b.priority];
        });
        
        // åº”ç”¨æ¯ä¸ªçº¦æŸ
        for (const constraint of sortedConstraints) {
          const matches = this.findConstraintMatches(processedText, constraint);
          
          for (const match of matches) {
            // åˆ›å»ºå ä½ç¬¦
            const placeholder = `__CONSTRAINT_${segments.length}__`;
            
            // è®°å½•çº¦æŸä¿¡æ¯
            segments.push({
              originalText: match.text,
              fixedTranslation: constraint.target,
              placeholder: placeholder,
              start: match.start,
              end: match.end,
              constraint: constraint
            });
            
            // ç”¨å ä½ç¬¦æ›¿æ¢åŸæ–‡æœ¬
            processedText = processedText.replace(match.text, placeholder);
          }
        }
        
        return { processedText, segments };
      },
      
      // æŸ¥æ‰¾çº¦æŸåŒ¹é…
      findConstraintMatches(text, constraint) {
        const matches = [];
        
        switch (constraint.type) {
          case 'exact':
            // ç²¾ç¡®åŒ¹é…
            const exactRegex = new RegExp(this.escapeRegex(constraint.source), 'gi');
            let exactMatch;
            while ((exactMatch = exactRegex.exec(text)) !== null) {
              matches.push({
                text: exactMatch[0],
                start: exactMatch.index,
                end: exactMatch.index + exactMatch[0].length
              });
            }
            break;
            
          case 'pattern':
            // æ¨¡å¼åŒ¹é…
            try {
              const patternRegex = new RegExp(constraint.source, 'gi');
              let patternMatch;
              while ((patternMatch = patternRegex.exec(text)) !== null) {
                matches.push({
                  text: patternMatch[0],
                  start: patternMatch.index,
                  end: patternMatch.index + patternMatch[0].length
                });
              }
            } catch (e) {
              console.warn('Invalid regex pattern in constraint:', constraint.source);
            }
            break;
            
          case 'context':
            // ä¸Šä¸‹æ–‡ç›¸å…³åŒ¹é…ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            if (text.toLowerCase().includes(constraint.source.toLowerCase())) {
              const contextMatch = text.match(new RegExp(this.escapeRegex(constraint.source), 'gi'));
              if (contextMatch) {
                contextMatch.forEach(match => {
                  const index = text.indexOf(match);
                  matches.push({
                    text: match,
                    start: index,
                    end: index + match.length
                  });
                });
              }
            }
            break;
        }
        
        return matches;
      },
      
      // åå¤„ç†ï¼šæ¢å¤çº¦æŸç¿»è¯‘
      postProcessWithConstraints(translatedText, segments) {
        let result = translatedText;
        
        // æŒ‰segmentsé¡ºåºæ¢å¤å›ºå®šç¿»è¯‘
        for (const segment of segments) {
          let fixedTranslation = segment.fixedTranslation;
          
          // å¤„ç†ç‰¹æ®Šå ä½ç¬¦
          if (fixedTranslation === '${match}') {
            fixedTranslation = segment.originalText; // ä¿æŒåŸæ–‡
          }
          
          // æ›¿æ¢å ä½ç¬¦
          result = result.replace(segment.placeholder, fixedTranslation);
        }
        
        return result;
      },
      
      // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
      escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      },
      
      // çº¦æŸå†²çªæ£€æµ‹
      detectConstraintConflicts() {
        const conflicts = [];
        const constraintMap = new Map();
        
        // æŒ‰æºæ–‡æœ¬åˆ†ç»„
        for (const constraint of appState.advancedPrompt.constraints) {
          const key = constraint.source.toLowerCase();
          if (!constraintMap.has(key)) {
            constraintMap.set(key, []);
          }
          constraintMap.get(key).push(constraint);
        }
        
        // æ£€æµ‹å†²çª
        for (const [source, constraints] of constraintMap) {
          if (constraints.length > 1) {
            const translations = new Set(constraints.map(c => c.target));
            if (translations.size > 1) {
              conflicts.push({
                source,
                constraints,
                type: 'multiple_translations',
                severity: 'high'
              });
            }
          }
        }
        
        return conflicts;
      },
      
      // æ™ºèƒ½çº¦æŸå»ºè®®
      suggestConstraintsFromGlossary() {
        const suggestions = [];
        
        // ä»è¯åº“ç”Ÿæˆçº¦æŸå»ºè®®
        for (const term of appState.glossary.terms) {
          const existingConstraint = appState.advancedPrompt.constraints.find(
            c => c.source.toLowerCase() === term.source.toLowerCase()
          );
          
          if (!existingConstraint) {
            suggestions.push({
              source: term.source,
              target: term.target,
              type: 'exact',
              priority: 'high',
              reason: 'From glossary terms'
            });
          }
        }
        
        return suggestions;
      },
      
      // ==================== æ’¤é”€ç³»ç»Ÿ ====================
      
      // æ’¤é”€ç®¡ç†å™¨
      undoManager: {
        // è®°å½•ç¿»è¯‘æ“ä½œ
        recordTranslationSession(sessionData) {
          const session = {
            id: sessionData.sessionId || Date.now().toString(),
            type: 'translation_batch',
            timestamp: Date.now(),
            sourceLang: sessionData.sourceLang,
            targetLang: sessionData.targetLang,
            engine: sessionData.engine,
            mode: sessionData.mode,
            operations: [],
            status: 'in_progress'
          };
          
          appState.undoSystem.currentSessionId = session.id;
          appState.undoSystem.history.unshift(session);
          
          // é™åˆ¶å†å²è®°å½•æ•°é‡
          if (appState.undoSystem.history.length > appState.undoSystem.maxHistory) {
            appState.undoSystem.history = appState.undoSystem.history.slice(0, appState.undoSystem.maxHistory);
          }
          
          return session.id;
        },
        
        // è®°å½•å•ä¸ªç¿»è¯‘æ“ä½œ
        recordTranslationOperation(nodeId, originalText, translatedText, applied = false) {
          const currentSession = this.getCurrentSession();
          if (!currentSession) return;
          
          const operation = {
            id: Date.now().toString(),
            nodeId,
            originalText,
            translatedText,
            applied,
            timestamp: Date.now()
          };
          
          currentSession.operations.push(operation);
        },
        
        // å®Œæˆç¿»è¯‘ä¼šè¯
        completeTranslationSession(sessionId, results) {
          const session = appState.undoSystem.history.find(s => s.id === sessionId);
          if (session) {
            session.status = 'completed';
            session.completedAt = Date.now();
            session.successCount = results.filter(r => r.status === 'success').length;
            session.failureCount = results.filter(r => r.status === 'error').length;
            session.totalCount = results.length;
          }
          appState.undoSystem.currentSessionId = null;
        },
        
        // è·å–å½“å‰ä¼šè¯
        getCurrentSession() {
          if (!appState.undoSystem.currentSessionId) return null;
          return appState.undoSystem.history.find(s => s.id === appState.undoSystem.currentSessionId);
        },
        
        // æ’¤é”€æ•´ä¸ªç¿»è¯‘ä¼šè¯
        undoTranslationSession(sessionId) {
          const session = appState.undoSystem.history.find(s => s.id === sessionId);
          if (!session) return false;
          
          const undoOperations = session.operations.filter(op => op.applied);
          
          if (undoOperations.length === 0) {
            ui.showNotification('è¯¥ä¼šè¯æ²¡æœ‰åº”ç”¨çš„ç¿»è¯‘å¯æ’¤é”€', 'warning');
            return false;
          }
          
          if (!confirm(`ç¡®å®šè¦æ’¤é”€è¿™æ¬¡ç¿»è¯‘ä¼šè¯å—ï¼Ÿè¿™å°†å½±å“ ${undoOperations.length} ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚`)) {
            return false;
          }
          
          // å‘é€æ’¤é”€è¯·æ±‚åˆ°ä¸»çº¿ç¨‹
          ui.postMessage('undo-translation-session', {
            sessionId: sessionId,
            operations: undoOperations
          });
          
          // æ ‡è®°ä¼šè¯ä¸ºå·²æ’¤é”€
          session.status = 'undone';
          session.undoneAt = Date.now();
          
          ui.showNotification(`å·²æ’¤é”€ç¿»è¯‘ä¼šè¯ï¼Œæ¢å¤äº† ${undoOperations.length} ä¸ªèŠ‚ç‚¹`, 'success');
          return true;
        },
        
        // æ’¤é”€ç‰¹å®šåŸå§‹æ–‡æœ¬çš„æ‰€æœ‰ç¿»è¯‘
        undoByOriginalText(originalText) {
          const affectedSessions = [];
          const affectedOperations = [];
          
          // æŸ¥æ‰¾æ‰€æœ‰åŒ…å«è¯¥åŸå§‹æ–‡æœ¬çš„æ“ä½œ
          for (const session of appState.undoSystem.history) {
            const matchingOps = session.operations.filter(op => 
              op.originalText.toLowerCase().includes(originalText.toLowerCase()) && op.applied
            );
            
            if (matchingOps.length > 0) {
              affectedSessions.push(session);
              affectedOperations.push(...matchingOps);
            }
          }
          
          if (affectedOperations.length === 0) {
            ui.showNotification('æ²¡æœ‰æ‰¾åˆ°åŒ…å«è¯¥æ–‡æœ¬çš„å·²åº”ç”¨ç¿»è¯‘', 'warning');
            return false;
          }
          
          if (!confirm(`æ‰¾åˆ° ${affectedOperations.length} ä¸ªåŒ…å« "${originalText}" çš„ç¿»è¯‘ã€‚ç¡®å®šè¦å…¨éƒ¨æ’¤é”€å—ï¼Ÿ`)) {
            return false;
          }
          
          // å‘é€æ‰¹é‡æ’¤é”€è¯·æ±‚
          ui.postMessage('undo-by-original-text', {
            originalText: originalText,
            operations: affectedOperations
          });
          
          // æ ‡è®°ç›¸å…³æ“ä½œä¸ºå·²æ’¤é”€
          affectedOperations.forEach(op => {
            op.undone = true;
            op.undoneAt = Date.now();
          });
          
          ui.showNotification(`å·²æ’¤é”€ ${affectedOperations.length} ä¸ªåŒ…å« "${originalText}" çš„ç¿»è¯‘`, 'success');
          return true;
        },
        
        // è·å–æ’¤é”€å†å²ç»Ÿè®¡
        getUndoHistoryStats() {
          const stats = {
            totalSessions: appState.undoSystem.history.length,
            completedSessions: 0,
            totalOperations: 0,
            successfulOperations: 0,
            undoneOperations: 0
          };
          
          appState.undoSystem.history.forEach(session => {
            if (session.status === 'completed') {
              stats.completedSessions++;
            }
            
            session.operations.forEach(op => {
              stats.totalOperations++;
              if (op.applied && !op.undone) {
                stats.successfulOperations++;
              }
              if (op.undone) {
                stats.undoneOperations++;
              }
            });
          });
          
          return stats;
        }
      },
      
      // æ˜¾ç¤ºæ’¤é”€å†å²ç•Œé¢
      showUndoHistory() {
        const historyHtml = `
          <div class="undo-history-modal" id="undo-history-modal">
            <div class="modal-overlay" onclick="ui.closeUndoHistory()"></div>
            <div class="modal-content">
              <div class="modal-header">
                <h3>Translation History & Undo</h3>
                <button onclick="ui.closeUndoHistory()" class="modal-close">Ã—</button>
              </div>
              <div class="modal-body">
                <div class="undo-tabs">
                  <button class="undo-tab active" onclick="ui.switchUndoTab('sessions')">Translation Sessions</button>
                  <button class="undo-tab" onclick="ui.switchUndoTab('text-search')">Text Search</button>
                  <button class="undo-tab" onclick="ui.switchUndoTab('stats')">Statistics</button>
                </div>
                <div id="undo-content"></div>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', historyHtml);
        this.switchUndoTab('sessions');
      },
      
      // å…³é—­æ’¤é”€å†å²
      closeUndoHistory() {
        const modal = document.getElementById('undo-history-modal');
        if (modal) {
          modal.remove();
        }
      },
      
      // åˆ‡æ¢æ’¤é”€æ ‡ç­¾é¡µ
      switchUndoTab(tabName) {
        // æ›´æ–°æ ‡ç­¾çŠ¶æ€
        document.querySelectorAll('.undo-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // æ›´æ–°å†…å®¹
        const content = document.getElementById('undo-content');
        switch (tabName) {
          case 'sessions':
            content.innerHTML = this.renderTranslationSessions();
            break;
          case 'text-search':
            content.innerHTML = this.renderTextSearchUndo();
            break;
          case 'stats':
            content.innerHTML = this.renderUndoStats();
            break;
        }
      },
      
      // æ¸²æŸ“ç¿»è¯‘ä¼šè¯åˆ—è¡¨
      renderTranslationSessions() {
        const sessions = appState.undoSystem.history;
        
        if (sessions.length === 0) {
          return '<div class="empty-state">No translation sessions found</div>';
        }
        
        return `
          <div class="sessions-list">
            ${sessions.map(session => `
              <div class="session-item ${session.status}">
                <div class="session-header">
                  <div class="session-info">
                    <div class="session-title">
                      ${session.sourceLang} â†’ ${session.targetLang} (${session.engine})
                    </div>
                    <div class="session-meta">
                      ${new Date(session.timestamp).toLocaleString()} â€¢ 
                      ${session.operations.length} operations â€¢ 
                      Mode: ${session.mode}
                    </div>
                  </div>
                  <div class="session-actions">
                    ${session.status === 'completed' ? `
                      <button class="btn btn-secondary btn-small" onclick="ui.undoManager.undoTranslationSession('${session.id}')">
                        Undo Session
                      </button>
                    ` : ''}
                    <span class="session-status ${session.status}">${session.status}</span>
                  </div>
                </div>
                <div class="session-details">
                  ${session.successCount || 0} successful, ${session.failureCount || 0} failed
                  ${session.status === 'undone' ? ` â€¢ Undone at ${new Date(session.undoneAt).toLocaleString()}` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      },
      
      // æ¸²æŸ“æ–‡æœ¬æœç´¢æ’¤é”€
      renderTextSearchUndo() {
        return `
          <div class="text-search-undo">
            <div class="search-form">
              <input type="text" class="input" id="undo-search-text" placeholder="è¾“å…¥è¦æ’¤é”€çš„åŸå§‹æ–‡æœ¬..." style="margin-bottom: 10px;">
              <button class="btn btn-primary" onclick="ui.searchAndUndoText()">Search & Undo</button>
            </div>
            <div id="search-results"></div>
          </div>
        `;
      },
      
      // æ¸²æŸ“æ’¤é”€ç»Ÿè®¡
      renderUndoStats() {
        const stats = this.undoManager.getUndoHistoryStats();
        
        return `
          <div class="undo-stats">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value">${stats.totalSessions}</div>
                <div class="stat-label">Total Sessions</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${stats.completedSessions}</div>
                <div class="stat-label">Completed Sessions</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${stats.totalOperations}</div>
                <div class="stat-label">Total Operations</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${stats.successfulOperations}</div>
                <div class="stat-label">Successful Operations</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">${stats.undoneOperations}</div>
                <div class="stat-label">Undone Operations</div>
              </div>
            </div>
            <div class="stats-actions">
              <button class="btn btn-secondary" onclick="ui.clearUndoHistory()">Clear History</button>
              <button class="btn btn-secondary" onclick="ui.exportUndoHistory()">Export History</button>
            </div>
          </div>
        `;
      },
      
      // æœç´¢å¹¶æ’¤é”€æ–‡æœ¬
      searchAndUndoText() {
        const searchText = document.getElementById('undo-search-text').value.trim();
        if (!searchText) {
          this.showNotification('è¯·è¾“å…¥æœç´¢æ–‡æœ¬', 'warning');
          return;
        }
        
        this.undoManager.undoByOriginalText(searchText);
      },
      
      // æ¸…ç†æ’¤é”€å†å²
      clearUndoHistory() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ’¤é”€å†å²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
          appState.undoSystem.history = [];
          this.showNotification('æ’¤é”€å†å²å·²æ¸…é™¤', 'success');
          this.closeUndoHistory();
        }
      },
      
      // å¯¼å‡ºæ’¤é”€å†å²
      exportUndoHistory() {
        const historyData = {
          exportedAt: new Date().toISOString(),
          history: appState.undoSystem.history
        };
        
        const blob = new Blob([JSON.stringify(historyData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `translation-history-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.showNotification('æ’¤é”€å†å²å·²å¯¼å‡º', 'success');
      },
      
      // æ„å»ºé¡¹ç›®ä¸Šä¸‹æ–‡
      buildProjectContext() {
        const prompt = appState.advancedPrompt;
        let context = `PROJECT CONTEXT:
- Type: ${prompt.projectType}`;
        
        if (prompt.industry) context += `\n- Industry: ${prompt.industry}`;
        context += `\n- Target Audience: ${prompt.targetAudience}`;
        context += `\n- Language Style: ${prompt.languageStyle}`;
        
        if (prompt.specialInstructions) {
          context += `\n- Special Instructions: ${prompt.specialInstructions}`;
        }
        
        return context;
      },
      
      // æ„å»ºçº¦æŸPrompt
      buildConstraintsPrompt() {
        if (appState.advancedPrompt.constraints.length === 0) {
          return '';
        }
        
        let constraintPrompt = 'FIXED TRANSLATION CONSTRAINTS:\n';
        appState.advancedPrompt.constraints.forEach(constraint => {
          constraintPrompt += `- "${constraint.source}" MUST be translated as "${constraint.target}"\n`;
        });
        
        return constraintPrompt;
      },
      
      // åŠ è½½è¿‡æ»¤å™¨è®¾ç½®
      loadFilterSettings() {
        const filters = appState.contentFilters;
        
        document.getElementById('filter-sf-symbols').checked = filters.skipSFSymbols;
        document.getElementById('filter-font-icons').checked = filters.skipFontIcons;
        document.getElementById('filter-unicode-private').checked = filters.skipUnicodePrivate;
        document.getElementById('filter-empty-text').checked = filters.skipEmptyText;
        document.getElementById('filter-single-chars').checked = filters.skipSingleChars;
        document.getElementById('filter-placeholders').checked = filters.skipPlaceholders;
        document.getElementById('custom-filter-patterns').value = filters.customPatterns;
        document.getElementById('skip-words').value = filters.skipWords;
      },
      
      // æµ‹è¯•è¿‡æ»¤å™¨
      testFilters() {
        const testText = document.getElementById('filter-test-input').value.trim();
        if (!testText) {
          this.showNotification('è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬', 'warning');
          return;
        }
        
        const shouldSkip = this.shouldSkipText(testText);
        const resultDiv = document.getElementById('filter-test-result');
        
        if (shouldSkip) {
          resultDiv.className = 'filter-test-result failed';
          resultDiv.textContent = `âŒ è¯¥æ–‡æœ¬å°†è¢«è·³è¿‡\nåŸå› : ${shouldSkip.reason}`;
        } else {
          resultDiv.className = 'filter-test-result passed';
          resultDiv.textContent = 'âœ… è¯¥æ–‡æœ¬å°†è¢«ç¿»è¯‘';
        }
      },
      
      // åˆ¤æ–­æ˜¯å¦è·³è¿‡æ–‡æœ¬
      shouldSkipText(text) {
        const filters = appState.contentFilters;
        
        // SF Symbolsæ£€æµ‹ - æ”¹è¿›æ£€æµ‹é€»è¾‘
        if (filters.skipSFSymbols) {
          // æ£€æµ‹SF Symbolsçš„Unicodeç§æœ‰åŒºåŸŸå­—ç¬¦
          if (/[\uE000-\uF8FF]/.test(text) || // ç§æœ‰ä½¿ç”¨åŒºåŸŸ
              /[\uF0000-\uFFFFF]/.test(text) || // è¡¥å……ç§æœ‰ä½¿ç”¨åŒºåŸŸA
              /[\u100000-\u10FFFF]/.test(text) || // è¡¥å……ç§æœ‰ä½¿ç”¨åŒºåŸŸB
              /^sf\./.test(text) || // ä»¥sf.å¼€å¤´çš„æ–‡æœ¬æ ‡è¯†
              text.length === 1 && text.charCodeAt(0) >= 0xE000 && text.charCodeAt(0) <= 0xF8FF) {
            return { skip: true, reason: 'SF Symbol or system icon detected' };
          }
        }
        
        // ç©ºç™½æ–‡æœ¬æ£€æµ‹
        if (filters.skipEmptyText && /^\s*$/.test(text)) {
          return { skip: true, reason: 'Empty or whitespace-only text' };
        }
        
        // å•å­—ç¬¦æ£€æµ‹
        if (filters.skipSingleChars && text.length === 1 && !/[\u4e00-\u9fff\u3400-\u4dbf]/.test(text)) {
          return { skip: true, reason: 'Single non-CJK character' };
        }
        
        // è‡ªå®šä¹‰è·³è¿‡è¯æ±‡
        if (filters.skipWords) {
          const skipWords = filters.skipWords.split(',').map(w => w.trim().toLowerCase());
          if (skipWords.some(word => text.toLowerCase().includes(word))) {
            return { skip: true, reason: 'Contains skip word' };
          }
        }
        
        // è‡ªå®šä¹‰æ­£åˆ™æ¨¡å¼
        if (filters.customPatterns) {
          const patterns = filters.customPatterns.split('\n').filter(p => p.trim());
          for (const pattern of patterns) {
            try {
              const regex = new RegExp(pattern.trim());
              if (regex.test(text)) {
                return { skip: true, reason: `Matches custom pattern: ${pattern}` };
              }
            } catch (e) {
              // å¿½ç•¥æ— æ•ˆæ­£åˆ™
            }
          }
        }
        
        return null;
      },
      
      // åŠ è½½é€šç”¨è®¾ç½®
      loadGeneralSettings() {
        const general = appState.general;
        
        document.getElementById('general-default-target-lang').value = appState.settings.defaultTargetLang;
        document.getElementById('ui-language').value = general.uiLanguage;
        document.getElementById('batch-size').value = general.batchSize;
        document.getElementById('enable-caching').checked = general.enableCaching;
        document.getElementById('auto-apply-translations').checked = general.autoApplyTranslations;
        document.getElementById('auto-save-glossary').checked = general.autoSaveGlossary;
      },
      
      // åŠ è½½è¯åº“è®¾ç½®
      loadGlossarySettings() {
        document.getElementById('glossary-enabled').checked = appState.glossary.enabled;
        document.getElementById('glossary-sensitivity').value = appState.glossary.sensitivity;
      },
      
      // ä¿å­˜é«˜çº§Promptè®¾ç½®
      saveAdvancedPromptSettings() {
        const projectType = document.getElementById('project-type');
        const industry = document.getElementById('project-industry');
        const targetAudience = document.getElementById('target-audience');
        const languageStyle = document.getElementById('language-style');
        const specialInstructions = document.getElementById('special-instructions');
        
        if (projectType) appState.advancedPrompt.projectType = projectType.value;
        if (industry) appState.advancedPrompt.industry = industry.value;
        if (targetAudience) appState.advancedPrompt.targetAudience = targetAudience.value;
        if (languageStyle) appState.advancedPrompt.languageStyle = languageStyle.value;
        if (specialInstructions) appState.advancedPrompt.specialInstructions = specialInstructions.value;
      },
      
      // ä¿å­˜å†…å®¹è¿‡æ»¤è®¾ç½®
      saveContentFilterSettings() {
        const skipSFSymbols = document.getElementById('filter-sf-symbols');
        const skipFontIcons = document.getElementById('filter-font-icons');
        const skipUnicodePrivate = document.getElementById('filter-unicode-private');
        const skipEmptyText = document.getElementById('filter-empty-text');
        const skipSingleChars = document.getElementById('filter-single-chars');
        const skipPlaceholders = document.getElementById('filter-placeholders');
        const customPatterns = document.getElementById('custom-filter-patterns');
        const skipWords = document.getElementById('skip-words');
        
        if (skipSFSymbols) appState.contentFilters.skipSFSymbols = skipSFSymbols.checked;
        if (skipFontIcons) appState.contentFilters.skipFontIcons = skipFontIcons.checked;
        if (skipUnicodePrivate) appState.contentFilters.skipUnicodePrivate = skipUnicodePrivate.checked;
        if (skipEmptyText) appState.contentFilters.skipEmptyText = skipEmptyText.checked;
        if (skipSingleChars) appState.contentFilters.skipSingleChars = skipSingleChars.checked;
        if (skipPlaceholders) appState.contentFilters.skipPlaceholders = skipPlaceholders.checked;
        if (customPatterns) appState.contentFilters.customPatterns = customPatterns.value;
        if (skipWords) appState.contentFilters.skipWords = skipWords.value;
      },
      
      // ä¿å­˜é€šç”¨è®¾ç½®
      saveGeneralSettings() {
        const defaultTargetLang = document.getElementById('general-default-target-lang');
        const uiLanguage = document.getElementById('ui-language');
        const batchSize = document.getElementById('batch-size');
        const enableCaching = document.getElementById('enable-caching');
        const autoApplyTranslations = document.getElementById('auto-apply-translations');
        const autoSaveGlossary = document.getElementById('auto-save-glossary');
        
        if (defaultTargetLang) appState.settings.defaultTargetLang = defaultTargetLang.value;
        if (uiLanguage) appState.general.uiLanguage = uiLanguage.value;
        if (batchSize) appState.general.batchSize = parseInt(batchSize.value);
        if (enableCaching) appState.general.enableCaching = enableCaching.checked;
        if (autoApplyTranslations) appState.general.autoApplyTranslations = autoApplyTranslations.checked;
        if (autoSaveGlossary) appState.general.autoSaveGlossary = autoSaveGlossary.checked;
      },
      
      // Utilities
      escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    };
    
    // Event listeners
    window.addEventListener('message', function(event) {
      if (event.data.pluginMessage) {
        ui.handleMessage(event.data.pluginMessage);
      }
    });
    
    // Engine toggles
    document.getElementById('openai-enabled').addEventListener('change', function() {
      ui.toggleEngine('openai', this.checked);
    });
    
    document.getElementById('gemini-enabled').addEventListener('change', function() {
      ui.toggleEngine('gemini', this.checked);
    });
    
    // Engine config changes
    ['openai', 'gemini'].forEach(engine => {
      document.getElementById(engine + '-key').addEventListener('input', function() {
        appState.engines[engine].apiKey = this.value.trim();
        ui.updateEngineDropdown();
      });
      
      document.getElementById(engine + '-model').addEventListener('change', function() {
        appState.engines[engine].model = this.value;
      });
    });
    
    // Font mapping toggle
    document.getElementById('font-mapping-enabled').addEventListener('change', function() {
      appState.fontMappingEnabled = this.checked;
      const content = document.getElementById('font-mapping-content');
      if (this.checked) {
        content.classList.add('active');
      } else {
        content.classList.remove('active');
      }
    });
    
    // Engine selection monitoring
    document.getElementById('engine').addEventListener('change', () => {
      ui.updateEngineInterface();
      ui.updateUI();
    });

    // Model and API key monitoring
    document.getElementById('model-select').addEventListener('change', () => ui.updateUI());
    document.getElementById('api-key').addEventListener('input', () => ui.updateUI());
    
    // Glossary input keyboard support
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        const glossarySourceInput = document.getElementById('glossary-source');
        const glossaryTargetInput = document.getElementById('glossary-target');
        
        if (glossarySourceInput) {
          glossarySourceInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              glossaryTargetInput.focus();
            }
          });
        }
        
        if (glossaryTargetInput) {
          glossaryTargetInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              ui.addGlossaryTerm();
            }
          });
        }
      }, 1000);
    });
    
    // Initialize UI
    ui.updateUI();
    
    // Try to connect to plugin
    setTimeout(() => {
      console.log('Attempting to connect to plugin...');
      ui.postMessage('get-selection');
    }, 500);
    
    console.log('TP Translator with Settings UI initialized');</script></body></html>