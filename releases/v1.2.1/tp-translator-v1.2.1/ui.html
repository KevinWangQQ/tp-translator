<!doctype html><html><head><meta charset="utf-8"><title>TP Translator</title><style>* { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      font-size: 13px;
      background: #ffffff;
      color: #1a1a1a;
      height: 100vh;
      line-height: 1.4;
    }
    
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
      max-width: 380px;
      margin: 0 auto;
    }
    
    /* Header */
    .header {
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 20px 12px;
      flex-shrink: 0;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .logo-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }
    
    .logo-text {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .settings-btn {
      background: none;
      border: none;
      padding: 6px;
      border-radius: 4px;
      cursor: pointer;
      color: #6b7280;
      font-size: 16px;
    }
    
    .settings-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    .settings-btn.active {
      background: #e0e7ff;
      color: #4338ca;
    }
    
    /* Navigation */
    .nav-tabs {
      display: flex;
      background: #f9fafb;
      border-radius: 8px;
      padding: 2px;
      gap: 2px;
    }
    
    .nav-tab {
      flex: 1;
      background: none;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #6b7280;
    }
    
    .nav-tab.active {
      background: #ffffff;
      color: #1a1a1a;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .nav-tab:hover:not(.active) {
      color: #374151;
    }
    
    /* Content */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    /* Settings Modal */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .settings-modal.active {
      display: flex;
    }
    
    .settings-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .settings-header {
      padding: 20px 24px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .settings-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }
    
    .close-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    /* Settings Tabs */
    .settings-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
      flex-shrink: 0;
    }
    
    .settings-tab {
      flex: 1;
      background: none;
      border: none;
      padding: 16px 24px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .settings-tab.active {
      color: #4338ca;
      border-bottom-color: #4338ca;
      background: white;
    }
    
    .settings-tab:hover:not(.active) {
      color: #374151;
      background: #f3f4f6;
    }
    
    .settings-body {
      padding: 20px 24px;
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
    
    .settings-section {
      margin-bottom: 32px;
    }
    
    .settings-section:last-child {
      margin-bottom: 0;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .section-icon {
      font-size: 16px;
    }
    
    /* Form Groups */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .form-col {
      flex: 1;
    }
    
    /* Inputs */
    .input, .select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
      background: #ffffff;
      transition: border-color 0.2s ease;
    }
    
    .input:focus, .select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .input::placeholder {
      color: #9ca3af;
    }
    
    /* Engine Cards */
    .engine-card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }
    
    .engine-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .engine-card.enabled {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .engine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .engine-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .engine-logo {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
      font-weight: 600;
    }
    
    .engine-logo.openai {
      background: linear-gradient(135deg, #00a67e 0%, #00d4aa 100%);
    }
    
    .engine-logo.gemini {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    }
    
    .engine-details h4 {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .engine-details p {
      font-size: 12px;
      color: #6b7280;
    }
    
    .engine-toggle {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    
    .engine-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #10b981;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .engine-config {
      display: none;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    
    .engine-config.active {
      display: block;
    }
    
    .engine-config.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    /* Selection Info */
    .selection-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .selection-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      display: block;
      font-size: 20px;
      font-weight: 600;
      color: #667eea;
      line-height: 1.2;
    }
    
    .stat-label {
      font-size: 11px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      margin-top: 2px;
    }
    
    .selection-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Buttons */
    .btn {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-decoration: none;
      white-space: nowrap;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary:hover {
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    .btn-full {
      width: 100%;
    }
    
    .btn-test {
      background: #3b82f6;
      color: white;
      padding: 8px 16px;
      font-size: 12px;
    }
    
    .btn-test:hover {
      background: #2563eb;
    }
    
    .btn-test:disabled {
      background: #9ca3af;
    }
    
    .btn-warning {
      background: #f59e0b;
      color: white;
      border: 1px solid #d97706;
    }
    
    .btn-warning:hover {
      background: #d97706;
      border-color: #b45309;
    }
    
    .btn-warning:disabled {
      background: #9ca3af;
      border-color: #6b7280;
    }
    
    /* Font Mapping */
    .font-mapping-section {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .font-mapping-header {
      background: #f9fafb;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      border-radius: 8px 8px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .font-mapping-title {
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }
    
    .font-mapping-content {
      padding: 16px;
      display: none;
    }
    
    .font-mapping-content.active {
      display: block;
    }
    
    .font-weight-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .font-weight-label {
      width: 70px;
      font-size: 12px;
      color: #6b7280;
      text-align: right;
    }
    
    .font-arrow {
      color: #9ca3af;
      font-size: 12px;
    }
    
    /* Progress */
    .progress-section {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      display: none;
    }
    
    .progress-section.active {
      display: block;
    }
    
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .progress-title {
      font-size: 13px;
      font-weight: 500;
      color: #374151;
    }
    
    .progress-percentage {
      font-size: 12px;
      color: #6b7280;
    }
    
    .progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    .progress-status {
      font-size: 12px;
      color: #64748b;
    }
    
    /* Results */
    .results-section {
      display: none;
    }
    
    .results-section.active {
      display: block;
    }
    
    .result-item {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    
    .result-item:hover {
      border-color: #d1d5db;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    
    .result-item.success {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .result-item.error {
      border-color: #ef4444;
      background: #fef2f2;
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .result-index {
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
    }
    
    .result-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    
    .result-status.success {
      background: #d1fae5;
      color: #065f46;
    }
    
    .result-status.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .result-text {
      margin-bottom: 8px;
    }
    
    .result-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      margin-bottom: 4px;
    }
    
    .result-content {
      background: #f8fafc;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      font-size: 13px;
      line-height: 1.4;
      word-break: break-word;
    }
    
    .result-content.error {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b;
    }
    
    .result-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }
    
    .apply-status {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .apply-status.applied {
      background: #d1fae5;
      color: #065f46;
    }
    
    .apply-status.not-applied {
      background: #fef3c7;
      color: #92400e;
    }
    
    /* Notifications */
    .notification {
      position: fixed;
      top: 16px;
      right: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1100;
      display: none;
      max-width: 300px;
    }
    
    .notification.success {
      background: #10b981;
      color: #ffffff;
    }
    
    .notification.error {
      background: #ef4444;
      color: #ffffff;
    }
    
    .notification.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Empty States */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    
    .empty-icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    
    .empty-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }
    
    .empty-description {
      font-size: 12px;
      line-height: 1.5;
    }
    
    /* Connection Status */
    .connection-status {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .connection-status.connected {
      background: #d1fae5;
      color: #065f46;
    }
    
    .connection-status.disconnected {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .connection-status.connecting {
      background: #fef3c7;
      color: #92400e;
    }
    
    /* Settings Footer */
    .settings-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      border-radius: 0 0 12px 12px;
    }
    
    .settings-version {
      font-size: 12px;
      color: #6b7280;
    }
    
    .settings-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Translation Memory */
    .memory-item {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .memory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .memory-langs {
      font-size: 11px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .memory-actions {
      display: flex;
      gap: 4px;
    }
    
    .memory-text {
      font-size: 12px;
      line-height: 1.4;
    }
    
    .memory-original {
      color: #374151;
      margin-bottom: 4px;
    }
    
    .memory-translated {
      color: #059669;
    }</style></head><body><div id="root"><div class="app"><header class="header"><div class="logo-section"><div class="logo"><div class="logo-icon">🔌</div><span class="logo-text">TP Translator</span></div><div class="header-actions"><span class="connection-status" id="connection-status">connecting</span> <button class="settings-btn" id="settings-btn" onclick="ui.toggleSettings()" title="Settings">⚙️</button></div></div><div class="nav-tabs"><button class="nav-tab active" onclick="ui.switchTab('home')">Home</button> <button class="nav-tab" onclick="ui.switchTab('translate')">Translate</button></div></header><div class="content"><div class="page active" id="home-page"><div class="form-group"><label class="form-label">Selection</label><div class="selection-card"><div class="selection-stats"><div class="stat-item"><span class="stat-value" id="total-nodes">0</span> <span class="stat-label">Total</span></div><div class="stat-item"><span class="stat-value" id="text-nodes">0</span> <span class="stat-label">Text Nodes</span></div></div><div class="selection-actions"><button class="btn btn-secondary btn-small" onclick="ui.refreshSelection()">🔄 Refresh</button> <button class="btn btn-secondary btn-small" onclick="ui.selectAllText()">📝 Select All Text</button></div></div></div><div class="form-group"><label class="form-label">Translation Engine</label><div class="form-row"><div class="form-col"><select class="select" id="engine"><option value="">Select Engine...</option></select></div><div class="form-col"><select class="select" id="model-select" style="display: none;"><option value="">Select Model...</option></select></div></div><div class="form-row" id="api-key-row" style="display: none; margin-top: 8px;"><div class="form-col"><input type="password" class="input" id="api-key" placeholder="Enter API Key"></div><div class="form-col" style="flex: 0 0 auto;"><button class="btn btn-secondary btn-small" onclick="ui.openEngineSettings()">⚙️ Configure</button></div></div></div><div class="form-group"><label class="form-label">Languages</label><div class="form-row"><div class="form-col"><select class="select" id="source-lang"><option value="auto">Auto-detect</option><option value="en">English</option><option value="zh-CN">Chinese (Simplified)</option><option value="ja">Japanese</option><option value="ko">Korean</option><option value="fr">French</option><option value="de">German</option><option value="es">Spanish</option></select></div><div class="form-col"><select class="select" id="target-lang"><option value="zh-CN">Chinese (Simplified)</option><option value="en">English</option><option value="ja">Japanese</option><option value="ko">Korean</option><option value="fr">French</option><option value="de">German</option><option value="es">Spanish</option></select></div></div></div><div class="form-group"><label class="form-label">Output Mode</label> <select class="select" id="output-mode"><option value="replace">Replace source text</option><option value="beside">Display beside</option><option value="newFrame">Display on new Frame</option><option value="newPage">Display on new page</option></select></div><div class="font-mapping-section"><div class="font-mapping-header"><span class="font-mapping-title">Font Mapping</span> <label class="engine-toggle"><input type="checkbox" id="font-mapping-enabled"> <span class="toggle-slider"></span></label></div><div class="font-mapping-content" id="font-mapping-content"><div class="font-weight-row"><span class="font-weight-label">Regular</span> <select class="select" style="flex: 1;"><option>Inter Regular</option><option>Roboto Regular</option><option>Arial Regular</option></select> <span class="font-arrow">→</span> <select class="select" style="flex: 1;"><option>Noto Sans SC Regular</option><option>PingFang SC Regular</option><option>Source Han Sans SC Regular</option></select></div><div class="font-weight-row"><span class="font-weight-label">Medium</span> <select class="select" style="flex: 1;"><option>Inter Medium</option><option>Roboto Medium</option><option>Arial Medium</option></select> <span class="font-arrow">→</span> <select class="select" style="flex: 1;"><option>Noto Sans SC Medium</option><option>PingFang SC Medium</option><option>Source Han Sans SC Medium</option></select></div><div class="font-weight-row"><span class="font-weight-label">Bold</span> <select class="select" style="flex: 1;"><option>Inter Bold</option><option>Roboto Bold</option><option>Arial Bold</option></select> <span class="font-arrow">→</span> <select class="select" style="flex: 1;"><option>Noto Sans SC Bold</option><option>PingFang SC Bold</option><option>Source Han Sans SC Bold</option></select></div></div></div><button class="btn btn-primary btn-full" id="translate-btn" onclick="ui.startTranslation()" disabled="disabled">🚀 Translate</button><div class="progress-section" id="progress-section"><div class="progress-header"><span class="progress-title">Translating...</span> <span class="progress-percentage" id="progress-percentage">0%</span></div><div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width: 0%"></div></div><div class="progress-status" id="progress-status">Initializing...</div></div></div><div class="page" id="translate-page"><div class="results-section active" id="results-section"><div class="form-group"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><label class="form-label">Translation Results</label><button class="btn btn-warning btn-small" id="rollback-all-btn" onclick="ui.rollbackAllTranslations()" style="display: none;">🔄 回退所有翻译</button></div><div id="results-container"><div class="empty-state"><div class="empty-icon">📄</div><div class="empty-title">No translations yet</div><div class="empty-description">Switch to Home tab to start translating</div></div></div></div></div></div></div></div><div class="settings-modal" id="settings-modal"><div class="settings-content"><div class="settings-header"><h2 class="settings-title">Settings</h2><button class="close-btn" onclick="ui.closeSettings()">×</button></div><div class="settings-tabs"><button class="settings-tab active" onclick="ui.switchSettingsTab('common')">Common</button> <button class="settings-tab" onclick="ui.switchSettingsTab('memories')">Translation Memories</button></div><div class="settings-body"><div class="settings-page active" id="common-settings"><div class="settings-section"><h3 class="section-title"><span class="section-icon">🔑</span> Translation Engines</h3><div class="engine-card" id="openai-card"><div class="engine-header"><div class="engine-info"><div class="engine-logo openai">AI</div><div class="engine-details"><h4>OpenAI</h4><p>GPT-3.5 & GPT-4 models</p></div></div><label class="engine-toggle"><input type="checkbox" id="openai-enabled"> <span class="toggle-slider"></span></label></div><div class="engine-config" id="openai-config"><div class="form-group"><label class="form-label">API Key</label> <input type="password" class="input" id="openai-key" placeholder="sk-..."></div><div class="form-group"><label class="form-label">Model</label> <select class="select" id="openai-model"><option value="gpt-3.5-turbo-instruct">GPT-3.5 Turbo Instruct</option><option value="gpt-4">GPT-4</option><option value="gpt-4-turbo">GPT-4 Turbo</option></select></div><button class="btn btn-test" onclick="ui.testEngine('openai')" id="openai-test-btn">Test Connection</button></div></div><div class="engine-card" id="gemini-card"><div class="engine-header"><div class="engine-info"><div class="engine-logo gemini">G</div><div class="engine-details"><h4>Google Gemini</h4><p>Gemini Pro & Flash models</p></div></div><label class="engine-toggle"><input type="checkbox" id="gemini-enabled"> <span class="toggle-slider"></span></label></div><div class="engine-config" id="gemini-config"><div class="form-group"><label class="form-label">API Key</label> <input type="password" class="input" id="gemini-key" placeholder="AIza..."></div><div class="form-group"><label class="form-label">Model</label> <select class="select" id="gemini-model"><option value="gemini-pro">Gemini Pro</option><option value="gemini-1.5-pro">Gemini 1.5 Pro</option><option value="gemini-1.5-flash">Gemini 1.5 Flash</option></select></div><button class="btn btn-test" onclick="ui.testEngine('gemini')" id="gemini-test-btn">Test Connection</button></div></div></div><div class="settings-section"><h3 class="section-title"><span class="section-icon">🌐</span> Default Languages</h3><div class="form-row"><div class="form-col"><label class="form-label">Default Target Language</label> <select class="select" id="default-target-lang"><option value="zh-CN">Chinese (Simplified)</option><option value="en">English</option><option value="ja">Japanese</option><option value="ko">Korean</option></select></div></div></div></div><div class="settings-page" id="memories-settings"><div class="settings-section"><h3 class="section-title"><span class="section-icon">🧠</span> Translation Memory</h3><div class="form-group"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><span class="form-label">Recent Translations</span> <button class="btn btn-secondary btn-small" onclick="ui.clearMemories()">Clear All</button></div><div id="translation-memories"><div class="empty-state"><div class="empty-icon">🧠</div><div class="empty-title">No translation memories</div><div class="empty-description">Your recent translations will appear here</div></div></div></div></div></div></div><div class="settings-footer"><span class="settings-version">v1.2.1 用户体验增强版</span><div class="settings-actions"><button class="btn btn-secondary" onclick="ui.closeSettings()">Cancel</button> <button class="btn btn-primary" onclick="ui.saveSettings()">Save Settings</button></div></div></div></div></div><div class="notification" id="notification"></div><script>console.log('TP Translator with Settings UI loading...');
    
    // Application state - 设置Gemini 1.5 Flash为默认引擎
    let appState = {
      connected: false,
      currentTab: 'home',
      currentSettingsTab: 'common',
      isTranslating: false,
      showingSettings: false,
      selection: { totalNodes: 0, textNodes: 0, nodeIds: [] },
      results: [],
      fontMappingEnabled: false,
      engines: {
        openai: { enabled: false, apiKey: '', model: 'gpt-3.5-turbo-instruct' },
        gemini: { enabled: true, apiKey: '', model: 'gemini-1.5-flash' } // 默认为Gemini 1.5 Flash
      },
      settings: {
        defaultTargetLang: 'zh-CN'
      },
      translationMemories: []
    };
    
    // UI Controller
    const ui = {
      // Tab switching
      switchTab(tabName) {
        console.log('Switching to tab:', tabName);
        appState.currentTab = tabName;
        
        // Update tab buttons
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update page content
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById(tabName + '-page').classList.add('active');
      },
      
      // Settings modal
      toggleSettings() {
        if (appState.showingSettings) {
          this.closeSettings();
        } else {
          this.showSettings();
        }
      },
      
      showSettings() {
        appState.showingSettings = true;
        document.getElementById('settings-modal').classList.add('active');
        document.getElementById('settings-btn').classList.add('active');
        this.loadSettings();
      },
      
      closeSettings() {
        appState.showingSettings = false;
        document.getElementById('settings-modal').classList.remove('active');
        document.getElementById('settings-btn').classList.remove('active');
      },
      
      switchSettingsTab(tabName) {
        appState.currentSettingsTab = tabName;
        
        // Update tab buttons
        document.querySelectorAll('.settings-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update page content
        document.querySelectorAll('.settings-page').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById(tabName + '-settings').classList.add('active');
      },
      
      // Engine management
      toggleEngine(engine, enabled) {
        appState.engines[engine].enabled = enabled;
        const card = document.getElementById(engine + '-card');
        const config = document.getElementById(engine + '-config');
        
        if (enabled) {
          card.classList.add('enabled');
          config.classList.add('active');
        } else {
          card.classList.remove('enabled');
          config.classList.remove('active');
        }
        
        this.updateEngineDropdown();
      },
      
      updateEngineDropdown() {
        const select = document.getElementById('engine');
        select.innerHTML = '';
        
        // 强制显示Gemini引擎（不管enabled状态），默认为1.5 Flash
        const geminiOption = document.createElement('option');
        geminiOption.value = 'gemini';
        geminiOption.textContent = 'Google Gemini (1.5 Flash)';
        geminiOption.selected = true; // 默认选中
        select.appendChild(geminiOption);
        
        // 只有启用OpenAI时才添加
        if (appState.engines.openai.enabled) {
          const openaiOption = document.createElement('option');
          openaiOption.value = 'openai';
          openaiOption.textContent = 'OpenAI GPT';
          select.appendChild(openaiOption);
        }
        
        // 如果下拉框为空，添加默认提示
        if (select.children.length === 0) {
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Select Engine...';
          select.appendChild(defaultOption);
        }
        
        this.updateUI();
        this.updateEngineInterface();
      },

      updateEngineInterface() {
        const selectedEngine = document.getElementById('engine').value;
        const modelSelect = document.getElementById('model-select');
        const apiKeyRow = document.getElementById('api-key-row');
        const apiKeyInput = document.getElementById('api-key');

        if (!selectedEngine) {
          modelSelect.style.display = 'none';
          apiKeyRow.style.display = 'none';
          return;
        }

        // Show model select and API key input
        modelSelect.style.display = 'block';
        apiKeyRow.style.display = 'flex';

        // Populate model options
        modelSelect.innerHTML = '<option value="">Select Model...</option>';
        
        if (selectedEngine === 'openai') {
          const models = [
            { value: 'gpt-3.5-turbo-instruct', label: 'GPT-3.5 Turbo Instruct' },
            { value: 'gpt-4', label: 'GPT-4' },
            { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' }
          ];
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.value;
            option.textContent = model.label;
            modelSelect.appendChild(option);
          });
        } else if (selectedEngine === 'gemini') {
          const models = [
            { value: 'gemini-pro', label: 'Gemini Pro' },
            { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
            { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' }
          ];
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.value;
            option.textContent = model.label;
            modelSelect.appendChild(option);
          });
        }

        // Set current values from state
        const engineConfig = appState.engines[selectedEngine];
        if (engineConfig) {
          modelSelect.value = engineConfig.model;
          apiKeyInput.value = engineConfig.apiKey;
        }
      },

      openEngineSettings() {
        this.showSettings();
        // Switch to common tab if not already there
        this.switchSettingsTab('common');
      },
      
      testEngine(engine) {
        const config = appState.engines[engine];
        if (!config.apiKey) {
          this.showNotification('Please enter API key first', 'error');
          return;
        }
        
        const testBtn = document.getElementById(engine + '-test-btn');
        testBtn.disabled = true;
        testBtn.textContent = 'Testing...';
        
        this.postMessage('test-engine', {
          engine: engine,
          config: { apiKey: config.apiKey, model: config.model }
        });
      },
      
      // Settings persistence
      loadSettings() {
        // Load engine settings
        Object.keys(appState.engines).forEach(engine => {
          const config = appState.engines[engine];
          document.getElementById(engine + '-enabled').checked = config.enabled;
          document.getElementById(engine + '-key').value = config.apiKey;
          document.getElementById(engine + '-model').value = config.model;
          
          this.toggleEngine(engine, config.enabled);
        });
        
        // Load other settings
        document.getElementById('default-target-lang').value = appState.settings.defaultTargetLang;
        
        // Load translation memories
        this.renderTranslationMemories();
      },
      
      saveSettings() {
        // Save engine settings
        Object.keys(appState.engines).forEach(engine => {
          appState.engines[engine] = {
            enabled: document.getElementById(engine + '-enabled').checked,
            apiKey: document.getElementById(engine + '-key').value.trim(),
            model: document.getElementById(engine + '-model').value
          };
        });
        
        // Save other settings
        appState.settings.defaultTargetLang = document.getElementById('default-target-lang').value;
        
        // Update target language default
        document.getElementById('target-lang').value = appState.settings.defaultTargetLang;
        
        this.updateEngineDropdown();
        this.closeSettings();
        this.showNotification('Settings saved successfully', 'success');
        
        // Persist to Figma storage
        this.postMessage('save-settings', {
          engines: appState.engines,
          settings: appState.settings,
          translationMemories: appState.translationMemories
        });
      },
      
      // Translation memories
      addTranslationMemory(original, translated, sourceLang, targetLang, engine) {
        const memory = {
          id: Date.now(),
          original,
          translated,
          sourceLang,
          targetLang,
          engine,
          timestamp: new Date().toISOString()
        };
        
        appState.translationMemories.unshift(memory);
        // Keep only last 50 memories
        appState.translationMemories = appState.translationMemories.slice(0, 50);
        
        this.renderTranslationMemories();
        
        // Auto-save translation memories
        this.postMessage('save-settings', {
          translationMemories: appState.translationMemories
        });
      },
      
      renderTranslationMemories() {
        const container = document.getElementById('translation-memories');
        
        if (appState.translationMemories.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">🧠</div>
              <div class="empty-title">No translation memories</div>
              <div class="empty-description">Your recent translations will appear here</div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = appState.translationMemories.map(memory => `
          <div class="memory-item">
            <div class="memory-header">
              <span class="memory-langs">${memory.sourceLang} → ${memory.targetLang}</span>
              <div class="memory-actions">
                <button class="btn btn-secondary btn-small" onclick="ui.reuseMemory('${memory.id}')">
                  Reuse
                </button>
                <button class="btn btn-secondary btn-small" onclick="ui.deleteMemory('${memory.id}')">
                  ×
                </button>
              </div>
            </div>
            <div class="memory-text">
              <div class="memory-original">${this.escapeHtml(memory.original)}</div>
              <div class="memory-translated">${this.escapeHtml(memory.translated)}</div>
            </div>
          </div>
        `).join('');
      },
      
      reuseMemory(memoryId) {
        const memory = appState.translationMemories.find(m => m.id == memoryId);
        if (memory) {
          document.getElementById('source-lang').value = memory.sourceLang;
          document.getElementById('target-lang').value = memory.targetLang;
          
          // Switch to engine if available
          if (appState.engines[memory.engine] && appState.engines[memory.engine].enabled) {
            document.getElementById('engine').value = memory.engine;
          }
          
          this.closeSettings();
          this.switchTab('home');
          this.showNotification('Translation settings applied', 'success');
        }
      },
      
      deleteMemory(memoryId) {
        appState.translationMemories = appState.translationMemories.filter(m => m.id != memoryId);
        this.renderTranslationMemories();
      },
      
      clearMemories() {
        if (confirm('Clear all translation memories?')) {
          appState.translationMemories = [];
          this.renderTranslationMemories();
          this.showNotification('Translation memories cleared', 'success');
        }
      },
      
      // Selection management
      refreshSelection() {
        console.log('Refreshing selection');
        this.postMessage('get-selection');
      },
      
      selectAllText() {
        console.log('Selecting all text in current page');
        this.postMessage('select-all-text');
      },
      
      // Translation
      startTranslation() {
        const engine = document.getElementById('engine').value;
        const model = document.getElementById('model-select').value;
        const apiKey = document.getElementById('api-key').value.trim();
        const sourceLang = document.getElementById('source-lang').value;
        const targetLang = document.getElementById('target-lang').value;
        const mode = document.getElementById('output-mode').value;
        
        if (!engine) {
          this.showNotification('Please select a translation engine', 'error');
          return;
        }
        
        if (!model) {
          this.showNotification('Please select a model', 'error');
          return;
        }
        
        if (!apiKey) {
          this.showNotification('Please enter API key', 'error');
          return;
        }
        
        if (appState.selection.textNodes === 0) {
          this.showNotification('Please select text nodes first', 'error');
          return;
        }
        
        console.log('Starting translation:', { engine, model, sourceLang, targetLang, mode });
        
        // Update engine config in state for future use
        appState.engines[engine].apiKey = apiKey;
        appState.engines[engine].model = model;
        
        appState.isTranslating = true;
        appState.results = [];
        this.updateUI();
        
        // Show progress
        document.getElementById('progress-section').classList.add('active');
        
        // Switch to translate tab to show results
        this.switchTab('translate');
        document.querySelector('.nav-tab[onclick*="translate"]').classList.add('active');
        document.querySelector('.nav-tab[onclick*="home"]').classList.remove('active');
        
        this.postMessage('start-translation', {
          engine: engine,
          sourceLang: sourceLang,
          targetLang: targetLang,
          mode: mode,
          nodeIds: appState.selection.nodeIds,
          config: { apiKey: apiKey, model: model }
        });
      },
      
      // Progress updates
      updateProgress(progress, status) {
        document.getElementById('progress-fill').style.width = progress + '%';
        document.getElementById('progress-percentage').textContent = Math.round(progress) + '%';
        document.getElementById('progress-status').textContent = status || 'Processing...';
      },
      
      // Results management
      addResult(result) {
        appState.results.push(result);
        this.renderResults();
        
        // Add to translation memory if successful
        if (result.status === 'success' && result.originalText && result.translatedText) {
          this.addTranslationMemory(
            result.originalText,
            result.translatedText,
            document.getElementById('source-lang').value,
            document.getElementById('target-lang').value,
            document.getElementById('engine').value
          );
        }
      },
      
      renderResults() {
        const container = document.getElementById('results-container');
        const rollbackBtn = document.getElementById('rollback-all-btn');
        
        if (appState.results.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">📄</div>
              <div class="empty-title">No translations yet</div>
              <div class="empty-description">Switch to Home tab to start translating</div>
            </div>
          `;
          rollbackBtn.style.display = 'none';
          return;
        }
        
        // Check if there are applied translations to show rollback button
        const appliedResults = appState.results.filter(result => result.applied && result.status === 'success');
        rollbackBtn.style.display = appliedResults.length > 0 ? 'block' : 'none';
        
        container.innerHTML = appState.results.map((result, index) => `
          <div class="result-item ${result.status}">
            <div class="result-header">
              <span class="result-index">#${index + 1}</span>
              <span class="result-status ${result.status}">
                ${result.status === 'success' ? 'SUCCESS' : 'ERROR'}
              </span>
            </div>
            <div class="result-text">
              <div class="result-label">Original</div>
              <div class="result-content">${this.escapeHtml(result.originalText)}</div>
            </div>
            ${result.translatedText ? `
              <div class="result-text">
                <div class="result-label">Translation</div>
                <div class="result-content" contenteditable="true" 
                     data-result-index="${index}" 
                     onblur="ui.handleTranslationEdit(this, ${index})"
                     style="cursor: text; border: 1px dashed #e2e8f0; padding: 8px; min-height: 20px;"
                     title="点击编辑翻译结果">${this.escapeHtml(result.translatedText)}</div>
              </div>
            ` : ''}
            ${result.error ? `
              <div class="result-text">
                <div class="result-label">Error</div>
                <div class="result-content error">${this.escapeHtml(result.error)}</div>
              </div>
            ` : ''}
            <!-- 强制显示操作按钮 - 不管状态如何 -->
            <div class="result-actions">
              ${result.status === 'success' ? `
                <span class="apply-status ${result.applied ? 'applied' : 'not-applied'}">
                  ${result.applied ? '✅ Auto-applied' : '⚠️ Not applied'}
                </span>
                ${!result.applied ? `
                  <button class="btn btn-warning btn-small" onclick="ui.retryApplyTranslation(${index})" title="重试应用翻译">
                    🔄 Retry
                  </button>
                ` : ''}
              ` : ''}
              
              <button class="btn btn-secondary btn-small" onclick="ui.copyTranslation(${index})">
                Copy
              </button>
              
              <!-- 节点定位按钮 - 始终显示（如果有结果） -->
              <button class="btn btn-secondary btn-small" onclick="ui.locateNode(${index})" 
                      title="在Figma中定位此文本" style="background: #17a2b8 !important; color: #fff !important;">
                🎯 定位
              </button>
            </div>
          </div>
        `).join('');
      },
      
      copyTranslation(index) {
        const result = appState.results[index];
        if (result && result.translatedText) {
          // 尝试使用现代 Clipboard API
          if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(result.translatedText).then(() => {
              this.showNotification('翻译已复制到剪贴板', 'success');
            }).catch(() => {
              this.fallbackCopy(result.translatedText);
            });
          } else {
            // 备用复制方法
            this.fallbackCopy(result.translatedText);
          }
        }
      },
      
      // 备用复制方法
      fallbackCopy(text) {
        try {
          // 创建临时文本域
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-9999px';
          textArea.style.top = '-9999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          // 执行复制
          const successful = document.execCommand('copy');
          document.body.removeChild(textArea);
          
          if (successful) {
            this.showNotification('翻译已复制到剪贴板', 'success');
          } else {
            this.showNotification('复制失败，请手动选择文本复制', 'error');
          }
        } catch (err) {
          console.error('Fallback copy failed:', err);
          this.showNotification('复制功能暂不可用', 'error');
        }
      },
      
      async retryApplyTranslation(index) {
        const result = appState.results[index];
        if (!result || !result.translatedText) {
          this.showNotification('No translation to apply', 'error');
          return;
        }
        
        // 更新按钮状态
        const retryBtn = document.querySelector(`button[onclick="ui.retryApplyTranslation(${index})"]`);
        if (retryBtn) {
          retryBtn.disabled = true;
          retryBtn.innerHTML = '🔄 Retrying...';
        }
        
        try {
          // 获取当前翻译模式
          const mode = document.getElementById('mode').value || 'replace';
          
          // 发送重试请求
          const response = await this.sendMessage({
            type: 'apply-translation',
            payload: {
              nodeId: result.nodeId,
              translatedText: result.translatedText,
              mode: mode
            }
          });
          
          if (response && response.payload && response.payload.success) {
            // 更新结果状态
            appState.results[index].applied = true;
            this.renderResults();
            this.showNotification('Translation applied successfully!', 'success');
          } else {
            const errorMsg = response?.payload?.error || 'Failed to apply translation';
            this.showNotification(`Retry failed: ${errorMsg}`, 'error');
          }
        } catch (error) {
          console.error('Retry apply translation error:', error);
          this.showNotification('Retry failed: ' + error.message, 'error');
        } finally {
          // 恢复按钮状态
          if (retryBtn) {
            retryBtn.disabled = false;
            retryBtn.innerHTML = '🔄 Retry';
          }
        }
      },
      
      // UI updates
      updateUI() {
        // Update selection stats
        document.getElementById('total-nodes').textContent = appState.selection.totalNodes;
        document.getElementById('text-nodes').textContent = appState.selection.textNodes;
        
        // Update translate button
        const translateBtn = document.getElementById('translate-btn');
        const hasSelection = appState.selection.textNodes > 0;
        const hasEngine = document.getElementById('engine').value !== '';
        const hasModel = document.getElementById('model-select').value !== '';
        const hasApiKey = document.getElementById('api-key').value.trim() !== '';
        
        const canTranslate = hasSelection && hasEngine && hasModel && hasApiKey;
        translateBtn.disabled = !canTranslate || appState.isTranslating;
        translateBtn.textContent = appState.isTranslating ? '🔄 Translating...' : '🚀 Translate';
        
        // Update connection status
        const statusEl = document.getElementById('connection-status');
        if (appState.connected) {
          statusEl.textContent = 'connected';
          statusEl.className = 'connection-status connected';
        } else {
          statusEl.textContent = 'disconnected';
          statusEl.className = 'connection-status disconnected';
        }
      },
      
      // Notifications
      showNotification(message, type) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} active`;
        
        setTimeout(() => {
          notification.classList.remove('active');
        }, 3000);
      },
      
      // Message handling
      postMessage(type, payload) {
        const message = { type: type, payload: payload || {} };
        console.log('Sending message:', message);
        parent.postMessage({ pluginMessage: message }, '*');
      },
      
      handleMessage(message) {
        console.log('Received message:', message.type, message);
        
        switch (message.type) {
          case 'plugin-ready':
            appState.connected = true;
            this.updateUI();
            this.showNotification('Plugin connected', 'success');
            // Load settings from storage
            this.postMessage('load-settings');
            setTimeout(() => this.refreshSelection(), 100);
            break;
            
          case 'selection-info':
            appState.selection = {
              totalNodes: message.payload.totalNodes || 0,
              textNodes: message.payload.textNodes || 0,
              nodeIds: message.payload.nodeIds || []
            };
            this.updateUI();
            break;
            
          case 'selection-changed':
            // 自动刷新选择信息，无需用户点击refresh
            appState.selection = {
              totalNodes: message.payload.totalNodes || 0,
              textNodes: message.payload.textNodes || 0,
              nodeIds: message.payload.nodeIds || []
            };
            this.updateUI();
            this.showNotification(`已选择 ${message.payload.textNodes} 个文本节点`, 'success');
            break;
            
          case 'translation-progress':
            this.updateProgress(message.payload.progress, message.payload.status);
            break;
            
          case 'translation-result':
            this.addResult(message.payload);
            break;
            
          case 'translation-complete':
            appState.isTranslating = false;
            this.updateUI();
            this.updateProgress(100, 'Complete');
            document.getElementById('progress-section').classList.remove('active');
            this.showNotification(
              `Translation complete! ${message.payload.successCount} success, ${message.payload.failureCount} failed`,
              'success'
            );
            break;
            
          case 'engine-test-result':
            const engine = message.payload.engine;
            const testBtn = document.getElementById(engine + '-test-btn');
            testBtn.disabled = false;
            
            if (message.payload.success) {
              testBtn.textContent = 'Test Connection';
              this.showNotification(`${engine} connection test passed`, 'success');
            } else {
              testBtn.textContent = 'Test Failed';
              this.showNotification(`${engine} test failed: ${message.payload.error}`, 'error');
              setTimeout(() => {
                testBtn.textContent = 'Test Connection';
              }, 2000);
            }
            break;
            
          case 'settings-loaded':
            console.log('Settings loaded:', message.payload);
            // Apply loaded settings to the UI state
            if (message.payload.engines) {
              appState.engines = message.payload.engines;
            }
            if (message.payload.settings) {
              appState.settings = message.payload.settings;
              document.getElementById('target-lang').value = appState.settings.defaultTargetLang;
            }
            if (message.payload.translationMemories) {
              appState.translationMemories = message.payload.translationMemories;
            }
            this.updateEngineDropdown();
            this.updateUI();
            break;
            
          case 'settings-save-result':
            if (message.payload.success) {
              console.log('Settings persisted to storage successfully');
            } else {
              this.showNotification('Failed to save settings: ' + message.payload.error, 'error');
            }
            break;
            
          case 'locate-result':
            if (message.payload.success) {
              this.showNotification('节点定位成功！', 'success');
            } else {
              this.showNotification(`定位失败: ${message.payload.error}`, 'error');
            }
            break;
            
          case 'rollback-complete':
            const { successCount, failureCount } = message.payload;
            if (successCount > 0) {
              // Update the applied status of rollback results
              appState.results.forEach(result => {
                if (result.applied && result.status === 'success') {
                  result.applied = false;
                }
              });
              this.renderResults();
              this.showNotification(`回退完成！成功回退 ${successCount} 个翻译`, 'success');
            }
            if (failureCount > 0) {
              this.showNotification(`有 ${failureCount} 个翻译回退失败`, 'error');
            }
            break;
            
          case 'update-translation-result':
            const updateResult = message.payload;
            if (updateResult.success) {
              this.showNotification('翻译已更新到Figma', 'success');
            } else {
              this.showNotification(`翻译更新失败: ${updateResult.error}`, 'error');
            }
            break;
            
          case 'error':
            this.showNotification(message.payload.error, 'error');
            if (appState.isTranslating) {
              appState.isTranslating = false;
              this.updateUI();
              document.getElementById('progress-section').classList.remove('active');
            }
            break;
            
          default:
            console.log('Unknown message type:', message.type);
        }
      },
      
      // 节点定位功能
      locateNode(index) {
        const result = appState.results[index];
        if (result && result.nodeId) {
          this.postMessage('locate-node', { nodeId: result.nodeId });
          this.showNotification('正在定位到该节点...', 'success');
        } else {
          this.showNotification('无法定位节点：节点ID缺失', 'error');
        }
      },
      
      // 一键回退所有翻译功能
      rollbackAllTranslations() {
        if (!appState.results || appState.results.length === 0) {
          this.showNotification('没有可回退的翻译结果', 'error');
          return;
        }
        
        const appliedResults = appState.results.filter(result => result.applied && result.status === 'success');
        if (appliedResults.length === 0) {
          this.showNotification('没有已应用的翻译需要回退', 'error');
          return;
        }
        
        if (!confirm(`确认回退 ${appliedResults.length} 个已应用的翻译？此操作会将文本恢复到翻译前的状态。`)) {
          return;
        }
        
        this.postMessage('rollback-all-translations', {
          results: appliedResults.map(result => ({
            nodeId: result.nodeId,
            originalText: result.originalText
          }))
        });
        
        this.showNotification('正在回退所有翻译...', 'success');
      },
      
      // 处理翻译结果手动编辑
      handleTranslationEdit(element, index) {
        const newTranslation = element.textContent.trim();
        const oldTranslation = appState.results[index].translatedText;
        
        if (newTranslation === oldTranslation) {
          return; // 没有变化
        }
        
        if (newTranslation === '') {
          this.showNotification('翻译结果不能为空', 'error');
          element.textContent = oldTranslation; // 恢复原值
          return;
        }
        
        // 检查是否有相同的原始文本，提供批量修改选项
        const sameOriginalResults = appState.results.filter(
          (result, idx) => idx !== index && 
          result.originalText === appState.results[index].originalText &&
          result.status === 'success'
        );
        
        if (sameOriginalResults.length > 0) {
          const applyToAll = confirm(
            `发现还有 ${sameOriginalResults.length} 个相同的原始文本"${appState.results[index].originalText}"。\n\n是否将此翻译应用到所有相同文本？\n\n点击"确定"批量应用，点击"取消"仅修改当前项。`
          );
          
          if (applyToAll) {
            // 批量更新所有相同原始文本的翻译
            const toUpdateInFigma = []; // 需要在Figma中同步的节点
            
            sameOriginalResults.forEach(result => {
              const resultIndex = appState.results.findIndex(r => r.nodeId === result.nodeId);
              if (resultIndex !== -1) {
                appState.results[resultIndex].translatedText = newTranslation;
                appState.results[resultIndex].manuallyEdited = true;
                
                // 如果这个结果已经应用到Figma，需要同步更新
                if (appState.results[resultIndex].applied) {
                  toUpdateInFigma.push({
                    nodeId: appState.results[resultIndex].nodeId,
                    translatedText: newTranslation
                  });
                }
              }
            });
            
            // 批量更新Figma中已应用的翻译
            if (toUpdateInFigma.length > 0) {
              toUpdateInFigma.forEach(update => {
                this.postMessage('update-translation', {
                  nodeId: update.nodeId,
                  translatedText: update.translatedText,
                  mode: document.getElementById('output-mode').value || 'replace'
                });
              });
              this.showNotification(`已批量更新 ${sameOriginalResults.length + 1} 个翻译结果并同步到Figma`, 'success');
            } else {
              this.showNotification(`已批量更新 ${sameOriginalResults.length + 1} 个翻译结果`, 'success');
            }
          }
        }
        
        // 更新当前结果
        appState.results[index].translatedText = newTranslation;
        appState.results[index].manuallyEdited = true;
        
        // 如果当前结果已应用，更新Figma中的翻译
        if (appState.results[index].applied && sameOriginalResults.length === 0) {
          // 只有在非批量操作时才单独发送当前项的更新
          this.postMessage('update-translation', {
            nodeId: appState.results[index].nodeId,
            translatedText: newTranslation,
            mode: document.getElementById('output-mode').value || 'replace'
          });
          this.showNotification('翻译已自动应用到Figma', 'success');
        } else if (appState.results[index].applied && sameOriginalResults.length > 0) {
          // 批量操作时，当前项也需要在Figma中更新
          this.postMessage('update-translation', {
            nodeId: appState.results[index].nodeId,
            translatedText: newTranslation,
            mode: document.getElementById('output-mode').value || 'replace'
          });
        }
        
        // 重新渲染结果以反映批量更新
        this.renderResults();
      },
      
      // Utilities
      escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    };
    
    // Event listeners
    window.addEventListener('message', function(event) {
      if (event.data.pluginMessage) {
        ui.handleMessage(event.data.pluginMessage);
      }
    });
    
    // Engine toggles
    document.getElementById('openai-enabled').addEventListener('change', function() {
      ui.toggleEngine('openai', this.checked);
    });
    
    document.getElementById('gemini-enabled').addEventListener('change', function() {
      ui.toggleEngine('gemini', this.checked);
    });
    
    // Engine config changes
    ['openai', 'gemini'].forEach(engine => {
      document.getElementById(engine + '-key').addEventListener('input', function() {
        appState.engines[engine].apiKey = this.value.trim();
        ui.updateEngineDropdown();
      });
      
      document.getElementById(engine + '-model').addEventListener('change', function() {
        appState.engines[engine].model = this.value;
      });
    });
    
    // Font mapping toggle
    document.getElementById('font-mapping-enabled').addEventListener('change', function() {
      appState.fontMappingEnabled = this.checked;
      const content = document.getElementById('font-mapping-content');
      if (this.checked) {
        content.classList.add('active');
      } else {
        content.classList.remove('active');
      }
    });
    
    // Engine selection monitoring
    document.getElementById('engine').addEventListener('change', () => {
      ui.updateEngineInterface();
      ui.updateUI();
    });

    // Model and API key monitoring
    document.getElementById('model-select').addEventListener('change', () => ui.updateUI());
    document.getElementById('api-key').addEventListener('input', () => ui.updateUI());
    
    // Initialize UI
    ui.updateUI();
    
    // Try to connect to plugin
    setTimeout(() => {
      console.log('Attempting to connect to plugin...');
      ui.postMessage('get-selection');
    }, 500);
    
    console.log('TP Translator with Settings UI initialized');</script></body></html>